<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Well-Architected Evidence Pack — {{ metadata.account_id }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    (function(){var k='ecad-theme';var v=null;try{v=localStorage.getItem(k);}catch(e){}if(!v&&typeof window.matchMedia!=='undefined'&&window.matchMedia('(prefers-color-scheme: light)').matches)v='light';document.documentElement.setAttribute('data-theme',v||'dark');})();
  </script>
  <style>
    /* Dark theme (default) */
    :root, [data-theme="dark"] {
      --bg: #09090b;
      --surface: #18181b;
      --surface-hover: #27272a;
      --border: rgba(255,255,255,.08);
      --text: #fafafa;
      --text-muted: #a1a1aa;
      --accent: #06b6d4;
      --accent-fg: #09090b;
      --accent-dim: rgba(6, 182, 212, .25);
      --success: #22c55e;
      --success-dim: rgba(34, 197, 94, .2);
      --warning: #f59e0b;
      --warning-dim: rgba(245, 158, 11, .2);
      --danger: #ef4444;
      --danger-dim: rgba(239, 68, 68, .2);
      --info: #71717a;
      --info-dim: rgba(113, 113, 122, .2);
      --radius: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 0.3s var(--ease);
    }
    /* Light theme */
    [data-theme="light"] {
      --bg: #fafafa;
      --surface: #ffffff;
      --surface-hover: #f4f4f5;
      --border: rgba(0,0,0,.08);
      --text: #18181b;
      --text-muted: #71717a;
      --accent: #0891b2;
      --accent-fg: #ffffff;
      --accent-dim: rgba(8, 145, 178, .2);
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #52525b;
    }
    [data-theme="light"] body {
      background-image: radial-gradient(ellipse at 50% 0%, rgba(0,0,0,.03) 0%, transparent 50%), linear-gradient(180deg, transparent 0%, var(--bg) 100%);
    }
    [data-theme="light"] .hero::before {
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(8, 145, 178, .12), transparent 50%),
        radial-gradient(ellipse 60% 40% at 80% 50%, rgba(99, 102, 241, .08), transparent 45%),
        radial-gradient(ellipse 50% 30% at 20% 80%, rgba(8, 145, 178, .06), transparent 40%);
    }
    [data-theme="light"] .hero h1 {
      background: linear-gradient(180deg, #18181b 0%, rgba(24,24,27,.9) 100%);
      -webkit-background-clip: text;
      background-clip: text;
    }
    [data-theme="light"] .scorecard-hero .score-big {
      background: linear-gradient(180deg, #18181b 0%, rgba(24,24,27,.85) 100%);
      -webkit-background-clip: text;
      background-clip: text;
    }
    [data-theme="light"] .tabs-wrap .tab-labels label:hover { border-color: rgba(0,0,0,.15); }
    [data-theme="light"] .tab-report-content tr:nth-child(even) { background: rgba(0,0,0,.02); }
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at 50% 0%, rgba(255,255,255,.03) 0%, transparent 50%),
        linear-gradient(180deg, transparent 0%, var(--bg) 100%);
      color: var(--text);
      line-height: 1.6;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 0 28px; }
    .hero {
      position: relative;
      padding: 72px 0 64px;
      overflow: hidden;
    }
    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(6, 182, 212, .18), transparent 50%),
        radial-gradient(ellipse 60% 40% at 80% 50%, rgba(99, 102, 241, .12), transparent 45%),
        radial-gradient(ellipse 50% 30% at 20% 80%, rgba(6, 182, 212, .08), transparent 40%);
      pointer-events: none;
    }
    .hero .container { position: relative; z-index: 1; }
    .hero-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
      padding-right: 56px;
      min-height: 44px;
    }
    .brand-wrap {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
      min-width: 0;
    }
    .brand-logo-frame {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 0;
      border-radius: 0;
      padding: 0;
      min-height: 0;
      min-width: 0;
    }
    .brand-logo {
      max-height: 156px;
      width: auto;
      max-width: 440px;
      object-fit: contain;
      display: block;
    }
    .brand-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .02em;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }
    @media (max-width: 768px) {
      .brand-logo-frame { min-height: 0; min-width: 0; padding: 0; }
      .brand-logo { max-height: 96px; max-width: 280px; }
      .brand-name { max-width: 200px; }
    }
    .hero .label {
      display: inline-block;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
    }
    .hero h1 {
      margin: 0 0 12px;
      font-size: clamp(36px, 5vw, 52px);
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.1;
      background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,.85) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero .meta {
      font-size: 15px;
      color: var(--text-muted);
      margin-bottom: 48px;
    }
    .hero .meta span + span::before { content: " · "; }
    .hero .container { position: relative; }
    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      font-size: 20px;
    }
    .theme-toggle:hover { color: var(--text); border-color: var(--accent); background: var(--surface-hover); }
    [data-theme="light"] .theme-toggle .icon-dark { display: none; }
    [data-theme="light"] .theme-toggle .icon-light { display: inline; }
    .theme-toggle .icon-light { display: none; }
    .theme-toggle .icon-dark { display: inline; }
    .pillar-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }
    .pillar-card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 18px 16px 18px;
      text-decoration: none;
      color: inherit;
      border: 1px solid var(--border);
      transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
      overflow: hidden;
      min-height: 210px;
    }
    .pillar-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, var(--pillar-color), transparent 50%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: .6;
      transition: opacity var(--transition);
    }
    .pillar-card:hover {
      transform: translateY(-4px);
      border-color: var(--pillar-color);
      box-shadow: 0 20px 40px -12px rgba(0,0,0,.5), 0 0 0 1px var(--pillar-color);
    }
    .pillar-card:hover::before { opacity: 1; }
    .pillar-card .name {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .pillar-card .badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 100px;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }
    .badge-success { background: var(--success-dim); color: #4ade80; }
    .badge-warning { background: var(--warning-dim); color: #fbbf24; }
    .badge-danger { background: var(--danger-dim); color: #f87171; }
    .badge-info { background: var(--info-dim); color: #a1a1aa; }
    .pillar-card .summary {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-top: auto;
      padding-top: 6px;
    }
    .pillar-hero-icon {
      width: 44px;
      height: 44px;
      margin-bottom: 12px;
      color: var(--pillar-color);
      flex-shrink: 0;
    }
    .pillar-hero-icon svg { width: 100%; height: 100%; display: block; }
    .pillar-section-icon {
      width: 72px;
      height: 72px;
      margin-bottom: 20px;
      color: var(--pillar-color);
    }
    .pillar-section-icon svg { width: 100%; height: 100%; display: block; }
    .nav-pillars {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(9, 9, 11, .8);
      backdrop-filter: saturate(180%) blur(24px);
      -webkit-backdrop-filter: saturate(180%) blur(24px);
      border-bottom: 1px solid var(--border);
      padding: 14px 0;
    }
    .nav-pillars .container { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .nav-pillars a {
      padding: 10px 18px;
      border-radius: 100px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }
    .nav-pillars a:hover {
      color: var(--text);
      border-color: var(--pillar-color);
      background: rgba(255,255,255,.03);
    }
    .nav-pillars a[data-color] { border-color: var(--pillar-color); color: var(--pillar-color); }
    .nav-pillars a[data-color]:hover { background: var(--pillar-color); color: var(--bg); }
    main { padding: 48px 0 100px; }
    .section-pillar {
      margin-bottom: 56px;
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: 40px 36px;
      border: 1px solid var(--border);
      border-top: 3px solid var(--pillar-color);
      box-shadow: 0 4px 24px -4px rgba(0,0,0,.3);
    }
    .section-pillar h2 {
      margin: 0 0 10px;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text);
    }
    .section-pillar .pillar-summary {
      color: var(--text-muted);
      margin-bottom: 32px;
      font-size: 16px;
      line-height: 1.6;
    }
    .accordion { margin-top: 12px; }
    .accordion details {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      overflow: hidden;
      background: rgba(255,255,255,.02);
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .accordion details:hover { border-color: rgba(255,255,255,.12); }
    .accordion details[open] {
      border-color: var(--pillar-color);
      box-shadow: 0 0 0 1px var(--pillar-color), 0 8px 24px -8px rgba(0,0,0,.4);
    }
    .accordion summary {
      padding: 20px 24px;
      font-weight: 600;
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
      font-size: 16px;
      transition: background var(--transition);
    }
    .accordion summary:hover { background: rgba(255,255,255,.04); }
    .accordion summary::-webkit-details-marker { display: none; }
    .accordion summary::after {
      content: "";
      width: 12px; height: 12px;
      margin-left: auto;
      border-right: 2px solid var(--text-muted);
      border-bottom: 2px solid var(--text-muted);
      transform: rotate(45deg);
      transition: transform var(--transition);
    }
    .accordion details[open] summary::after { transform: rotate(-135deg); }
    .accordion .q-id {
      font-size: 12px;
      font-weight: 700;
      color: var(--pillar-color);
      flex-shrink: 0;
      letter-spacing: 0.04em;
    }
    .accordion .content {
      padding: 0 24px 24px;
      border-top: 1px solid var(--border);
    }
    .accordion .compliance-msg {
      margin: 18px 0 14px;
      padding: 18px 22px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.5;
    }
    .accordion .compliance-msg.status-compliant { background: var(--success-dim); color: #86efac; border: 1px solid rgba(34, 197, 94, .3); }
    .accordion .compliance-msg.status-partial { background: var(--warning-dim); color: #fcd34d; border: 1px solid rgba(245, 158, 11, .3); }
    .accordion .compliance-msg.status-not-compliant { background: var(--danger-dim); color: #fca5a5; border: 1px solid rgba(239, 68, 68, .3); }
    .accordion .compliance-msg.status-na { background: var(--info-dim); color: #d4d4d8; border: 1px solid rgba(113, 113, 122, .3); }
    .accordion ul.evidences, .accordion ul.practices { margin: 12px 0; padding-left: 22px; }
    .accordion ul.evidences li { margin: 8px 0; font-size: 15px; line-height: 1.5; }
    .accordion .servicios-list { margin: 8px 0; font-size: 14px; line-height: 1.5; color: var(--text-muted); }
    .accordion .servicios-list.missing { color: var(--danger); }
    .accordion .ev-ok { color: #4ade80; }
    .accordion .ev-warn { color: #fbbf24; }
    .accordion .ev-fail { color: #f87171; }
    .accordion .ev-info { color: #a1a1aa; }
    .accordion .practices { font-size: 15px; color: var(--text-muted); line-height: 1.55; }
    .accordion p strong {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .footer {
      text-align: center;
      padding: 40px 28px;
      color: var(--text-muted);
      font-size: 13px;
      border-top: 1px solid var(--border);
    }
    .tabs-wrap { margin: 0 0 32px; }
    .tabs-wrap .tab-labels {
      display: flex;
      gap: 8px;
      padding: 0 28px;
      max-width: 1000px;
      margin: 0 auto 24px;
    }
    .tabs-wrap .tab-labels {
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .tabs-wrap .tab-labels label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 44px;
      padding: 10px 20px;
      border-radius: 100px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border);
      color: var(--text-muted);
      transition: all var(--transition);
      line-height: 1.3;
      white-space: normal;
      word-break: break-word;
    }
    .tabs-wrap .tab-labels label:hover { color: var(--text); border-color: rgba(255,255,255,.2); }
    .tabs-wrap input[name="main-tab"] { display: none; }
    .tabs-wrap input#tab-scorecard:checked ~ .tab-labels label[for="tab-scorecard"],
    .tabs-wrap input#tab-evidence:checked ~ .tab-labels label[for="tab-evidence"],
    .tabs-wrap input#tab-caf:checked ~ .tab-labels label[for="tab-caf"],
    .tabs-wrap input#tab-maturity:checked ~ .tab-labels label[for="tab-maturity"],
    .tabs-wrap input#tab-phases:checked ~ .tab-labels label[for="tab-phases"],
    .tabs-wrap input#tab-inventory:checked ~ .tab-labels label[for="tab-inventory"],
    .tabs-wrap input#tab-improvement-plan:checked ~ .tab-labels label[for="tab-improvement-plan"],
    .tabs-wrap input#tab-tagging:checked ~ .tab-labels label[for="tab-tagging"] {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--accent-fg);
    }
    .tabs-wrap .tab-panel { display: none; }
    .tabs-wrap input#tab-scorecard:checked ~ .tab-panel#panel-scorecard,
    .tabs-wrap input#tab-evidence:checked ~ .tab-panel#panel-evidence,
    .tabs-wrap input#tab-caf:checked ~ .tab-panel#panel-caf,
    .tabs-wrap input#tab-maturity:checked ~ .tab-panel#panel-maturity,
    .tabs-wrap input#tab-phases:checked ~ .tab-panel#panel-phases,
    .tabs-wrap input#tab-inventory:checked ~ .tab-panel#panel-inventory,
    .tabs-wrap input#tab-improvement-plan:checked ~ .tab-panel#panel-improvement-plan,
    .tabs-wrap input#tab-tagging:checked ~ .tab-panel#panel-tagging { display: block; }
    .tab-report-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 32px 28px 48px;
    }
    .tab-report-content h1,.tab-report-content h2,.tab-report-content h3 { margin: 1.25em 0 0.5em; color: var(--text); }
    .tab-report-content p { margin: 0.75em 0; }
    .tab-report-content ul, .tab-report-content ol { margin: 0.75em 0; padding-left: 1.5em; }
    .tab-report-content pre { background: var(--surface); padding: 1rem; border-radius: var(--radius); overflow-x: auto; font-size: 14px; }
    .tab-report-placeholder { color: var(--text-muted); text-align: center; padding: 48px 28px; }
    .tab-report-placeholder p { margin: 0.5em 0; }
    .tab-report-content table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 14px; }
    .tab-report-content th, .tab-report-content td { border: 1px solid var(--border); padding: 10px 14px; text-align: left; }
    .tab-report-content th { background: var(--surface); color: var(--accent); font-weight: 600; }
    .tab-report-content tr:nth-child(even) { background: rgba(255,255,255,.02); }
    /* Estilos para Plan de mejoras por dificultad */
    #panel-improvement-plan .improvement-section {
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    #panel-improvement-plan .improvement-pronta {
      border-left: 4px solid #22c55e; /* verde – más fácil / 30 días */
      background: rgba(34, 197, 94, 0.05);
    }
    #panel-improvement-plan .improvement-mri {
      border-left: 4px solid #f97316; /* naranja – mayor complejidad */
      background: rgba(249, 115, 22, 0.05);
    }
    .remediation-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 28px 48px;
    }
    .remediation-hero {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 20px;
    }
    .remediation-hero h2 {
      margin: 0 0 8px;
      font-size: 24px;
      letter-spacing: -0.02em;
    }
    .remediation-meta {
      color: var(--text-muted);
      font-size: 14px;
    }
    .remediation-stats {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .remediation-stat {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      background: rgba(255,255,255,.02);
    }
    .remediation-stat .v {
      font-size: 24px;
      font-weight: 800;
      line-height: 1;
    }
    .remediation-stat .l {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-top: 6px;
    }
    .remediation-phase {
      margin-top: 20px;
    }
    .remediation-phase h3 {
      margin: 0 0 12px;
      font-size: 20px;
      letter-spacing: -0.01em;
    }
    .remediation-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .remediation-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      overflow: hidden;
    }
    .remediation-card summary {
      cursor: pointer;
      list-style: none;
      padding: 16px 18px;
      display: grid;
      gap: 8px;
      border-left: 4px solid var(--accent);
    }
    .remediation-card summary::-webkit-details-marker { display: none; }
    .remediation-title {
      font-weight: 700;
      font-size: 15px;
      line-height: 1.35;
    }
    .remediation-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .r-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 600;
    }
    .r-risk-high { color: #fca5a5; border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); }
    .r-risk-medium { color: #fcd34d; border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.12); }
    .r-risk-low { color: #86efac; border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.12); }
    .remediation-body {
      border-top: 1px solid var(--border);
      padding: 16px 18px 18px;
    }
    .remediation-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }
    .remediation-box {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      padding: 12px 14px;
    }
    .remediation-box h4 {
      margin: 0 0 8px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .07em;
    }
    .remediation-box ol, .remediation-box ul {
      margin: 0;
      padding-left: 18px;
      font-size: 14px;
      line-height: 1.45;
    }
    .remediation-box li { margin: 6px 0; }
    .remediation-box p { margin: 0; font-size: 14px; }
    .remediation-links a {
      color: var(--accent);
      text-decoration: none;
    }
    .remediation-links a:hover { text-decoration: underline; }
    .remediation-toolbar {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .remediation-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px;
    }
    .remediation-filters input,
    .remediation-filters select {
      width: 100%;
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .remediation-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .remediation-actions .left {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .remediation-actions button {
      border: 1px solid var(--border);
      background: var(--surface-hover);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .remediation-actions button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .remediation-count {
      font-size: 12px;
      color: var(--text-muted);
    }
    .coverage-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 28px 48px;
    }
    .coverage-hero {
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      background: var(--surface);
      padding: 22px;
      margin-bottom: 16px;
    }
    .coverage-hero h2 { margin: 0 0 8px; font-size: 24px; letter-spacing: -0.02em; }
    .coverage-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .coverage-kpi {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: rgba(255,255,255,.02);
    }
    .coverage-kpi .v { font-size: 24px; font-weight: 800; line-height: 1; }
    .coverage-kpi .l { margin-top: 6px; color: var(--text-muted); font-size: 12px; letter-spacing: .06em; text-transform: uppercase; }
    .coverage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .coverage-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 14px;
    }
    .coverage-card h3 { margin: 0 0 10px; font-size: 16px; }
    .coverage-metric { margin-bottom: 8px; }
    .coverage-metric .head { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .coverage-bar { height: 8px; border-radius: 999px; background: rgba(255,255,255,.08); overflow: hidden; }
    .coverage-bar > span { display: block; height: 100%; border-radius: inherit; }
    .coverage-bar.cover > span { background: #22c55e; }
    .coverage-bar.conf > span { background: #06b6d4; }
    .coverage-bar.ne > span { background: #f59e0b; }
    .coverage-foot { margin-top: 12px; color: var(--text-muted); font-size: 12px; line-height: 1.5; }
    .coverage-lens-tags {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .coverage-lens-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: .03em;
      text-transform: uppercase;
    }
    .lens-origin {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 2px 7px;
      font-size: 10px;
      letter-spacing: .05em;
      text-transform: uppercase;
      font-weight: 700;
    }
    .lens-origin-official {
      color: #86efac;
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.12);
    }
    .lens-origin-custom {
      color: #fcd34d;
      border-color: rgba(245,158,11,.45);
      background: rgba(245,158,11,.12);
    }
    .coverage-global {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 14px;
      margin-bottom: 14px;
    }
    .coverage-global h3 {
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .scorecard-hero {
      text-align: center;
      padding: 40px 28px 32px;
    }
    .scorecard-hero .score-big {
      font-size: 64px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1;
      background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .scorecard-hero .score-big span { font-size: 28px; color: var(--text-muted); font-weight: 600; }
    .scorecard-hero .score-subtitle { color: var(--text-muted); margin-top: 8px; font-size: 15px; }
    .score-mode-toggle {
      margin-top: 16px;
      display: inline-flex;
      gap: 8px;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface);
    }
    .score-mode-toggle button {
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }
    .score-mode-toggle button:hover {
      color: var(--text);
      border-color: var(--border);
    }
    .score-mode-toggle button.is-active {
      background: var(--accent);
      color: var(--accent-fg);
      border-color: var(--accent);
    }
    .score-mode-help {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    .scorecard-hero .score-formula {
      margin-top: 20px;
      padding: 16px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--text-muted);
      text-align: left;
      max-width: 560px;
      margin-left: auto;
      margin-right: auto;
    }
    .scorecard-hero .score-formula strong { color: var(--text); }
    .scorecard-hero .score-formula code { background: var(--surface-hover); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .score-radar-wrap {
      margin-top: 32px;
      text-align: center;
    }
    .score-radar-wrap h2 {
      font-size: 18px;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }
    .score-radar {
      display: inline-block;
      max-width: 320px;
      width: 100%;
    }
    .score-radar svg {
      width: 100%;
      height: auto;
      display: block;
    }
    .score-radar-grid {
      stroke: var(--border);
      stroke-width: 1;
      fill: none;
    }
    .score-radar-axis {
      stroke: var(--border);
      stroke-width: 1;
      stroke-dasharray: 2 3;
    }
    .score-radar-polygon {
      fill: var(--accent);
      fill-opacity: 0.12;
      stroke: var(--accent);
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-dasharray: 4 3;
    }
    .score-radar-label {
      font-size: 11px;
      fill: var(--text-muted);
    }
    .scorecard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 28px 48px;
    }
    .scorecard-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
      border-left: 4px solid var(--pillar-color);
    }
    .scorecard-card .name {
      font-weight: 700;
      font-size: 15px;
      line-height: 1.3;
      margin-bottom: 8px;
      word-break: break-word;
    }
    .scorecard-card .score-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .scorecard-card .score-num { font-size: 28px; font-weight: 800; color: var(--pillar-color); }
    .scorecard-card .score-label { font-size: 14px; color: var(--text-muted); }
    .scorecard-card .summary { font-size: 14px; color: var(--text-muted); line-height: 1.5; }
    .phases-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 28px 48px;
    }
    .phases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .phase-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 16px;
    }
    .phase-card h3 {
      margin: 0 0 8px;
      font-size: 17px;
      letter-spacing: -0.01em;
    }
    .phase-card p {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
    }
    .phase-metrics {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(2, minmax(100px, 1fr));
      gap: 8px;
    }
    .phase-kpi {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(255,255,255,.02);
    }
    .phase-kpi .v { font-size: 18px; font-weight: 800; line-height: 1; }
    .phase-kpi .l { font-size: 11px; color: var(--text-muted); margin-top: 5px; text-transform: uppercase; letter-spacing: .05em; }
    .phase-status {
      display: inline-block;
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .phase-ready-list {
      margin-top: 10px;
      padding-left: 18px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .phase-ready-list li { margin: 6px 0; }
    .phase-lenses-list {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }
    .phase-lens-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,.02);
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .phase-lens-item .meta { color: var(--text-muted); }
    .caf-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 28px 48px;
    }
    .caf-hero {
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      background: var(--surface);
      padding: 20px;
      margin-bottom: 14px;
    }
    .caf-hero h2 {
      margin: 0 0 8px;
      font-size: 24px;
      letter-spacing: -0.02em;
    }
    .caf-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .caf-kpi {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
    }
    .caf-kpi .v {
      font-size: 22px;
      font-weight: 800;
      line-height: 1;
    }
    .caf-kpi .l {
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .caf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }
    .caf-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 14px;
    }
    .caf-card-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .caf-head-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .caf-semaphore {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      flex: 0 0 auto;
      margin-top: 2px;
    }
    .caf-semaphore.aligned { background: #22c55e; border-color: rgba(34,197,94,.55); }
    .caf-semaphore.attention { background: #f59e0b; border-color: rgba(245,158,11,.55); }
    .caf-semaphore.at_risk { background: #ef4444; border-color: rgba(239,68,68,.55); }
    .caf-semaphore.organizational { background: #8b5cf6; border-color: rgba(139,92,246,.55); }
    .caf-semaphore.manual { background: #06b6d4; border-color: rgba(6,182,212,.55); }
    .caf-card h3 {
      margin: 0;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .caf-desc {
      margin: 0 0 10px;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .caf-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .caf-badge.aligned { color: #86efac; border-color: rgba(134,239,172,.4); }
    .caf-badge.attention { color: #fcd34d; border-color: rgba(252,211,77,.4); }
    .caf-badge.at_risk { color: #fca5a5; border-color: rgba(252,165,165,.4); }
    .caf-badge.organizational { color: #c4b5fd; border-color: rgba(196,181,253,.4); }
    .caf-badge.manual { color: #7dd3fc; border-color: rgba(125,211,252,.4); }
    .caf-item-list {
      display: grid;
      gap: 8px;
    }
    .caf-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,.02);
      padding: 10px;
    }
    .caf-item-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .caf-item-title {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
      line-height: 1.35;
    }
    .caf-chip-org {
      display: inline-flex;
      margin-left: 6px;
      border: 1px solid rgba(196,181,253,.45);
      color: #c4b5fd;
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .05em;
      font-weight: 700;
      vertical-align: middle;
    }
    .caf-item-meta {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.45;
    }
    .caf-item-meta a {
      color: #67e8f9;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .caf-org-backlog {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 14px;
    }
    .caf-org-backlog h3 {
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .caf-org-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 8px;
      font-size: 13px;
      line-height: 1.45;
    }
    .caf-org-list a {
      color: #67e8f9;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .wafr-explorer {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--surface);
      padding: 14px;
    }
    .wafr-explorer h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      letter-spacing: -0.02em;
    }
    .wafr-toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 0 0 10px 0;
    }
    .wafr-toolbar input,
    .wafr-toolbar select {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
    }
    .wafr-toolbar input { min-width: 240px; flex: 1; }
    .wafr-table-wrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      max-height: 380px;
      overflow-y: auto;
    }
    .wafr-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .wafr-table th,
    .wafr-table td {
      border-bottom: 1px solid var(--border);
      text-align: left;
      padding: 8px 10px;
      vertical-align: top;
    }
    .wafr-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-muted);
      background: rgba(255,255,255,.03);
    }
    .wafr-table tr:hover td { background: rgba(255,255,255,.02); }
    .wafr-table tr.is-selected td { background: rgba(56,189,248,.10); }
    .wafr-row-btn {
      border: 0;
      background: transparent;
      color: var(--text);
      padding: 0;
      margin: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
      cursor: pointer;
      font: inherit;
      text-align: left;
    }
    .wafr-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid transparent;
    }
    .wafr-badge.compliant { color: #86efac; border-color: rgba(134,239,172,.4); }
    .wafr-badge.evaluated { color: #7dd3fc; border-color: rgba(125,211,252,.4); }
    .wafr-badge.partially_compliant { color: #fcd34d; border-color: rgba(252,211,77,.4); }
    .wafr-badge.not_compliant { color: #fca5a5; border-color: rgba(252,165,165,.4); }
    .wafr-badge.not_evaluable { color: #c4b5fd; border-color: rgba(196,181,253,.4); }
    .wafr-legend {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
    }
    .wafr-legend summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text);
    }
    .wafr-legend summary::-webkit-details-marker { display: none; }
    .wafr-legend summary::after {
      content: "▼";
      font-size: 10px;
      color: var(--text-muted);
      transition: transform .2s ease;
    }
    .wafr-legend[open] summary::after {
      transform: rotate(180deg);
    }
    .wafr-legend-content {
      margin-top: 8px;
    }
    .wafr-legend-list {
      display: grid;
      gap: 6px;
      margin: 0;
      padding: 0;
      list-style: none;
      font-size: 12px;
      color: var(--text-muted);
    }
    .wafr-legend-list li {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .wafr-detail {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      padding: 12px;
    }
    .wafr-detail h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      letter-spacing: -0.01em;
    }
    .wafr-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .wafr-detail-grid .v { color: var(--text); }
    .wafr-detail-grid .v a { color: #67e8f9; text-decoration: underline; text-underline-offset: 2px; }
    .wafr-chips {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .wafr-chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(255,255,255,.02);
    }
    .inventory-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 28px 48px;
    }
    .inventory-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }
    .inventory-toolbar {
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .inventory-toolbar label {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: .03em;
      text-transform: uppercase;
    }
    .inventory-toolbar select,
    .inventory-toolbar input {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      min-width: 180px;
    }
    .inventory-toolbar input {
      min-width: 260px;
      flex: 1;
    }
    .inventory-list-view,
    .inventory-service-view {
      display: block;
    }
    .inventory-service-view {
      display: none;
    }
    .inventory-service-view.is-open {
      display: block;
    }
    .inventory-list-view.is-hidden {
      display: none;
    }
    .inventory-explorer {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--surface);
    }
    .inventory-main-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .inventory-main-table th,
    .inventory-main-table td {
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      vertical-align: top;
      text-align: left;
    }
    .inventory-main-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-muted);
      background: rgba(255,255,255,.02);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .inventory-main-table tr:hover td {
      background: rgba(255,255,255,.03);
    }
    .inventory-main-table tr.is-selected td {
      background: rgba(6, 182, 212, .08);
    }
    .inventory-service {
      font-weight: 700;
      font-size: 14px;
    }
    .inventory-service-link {
      border: 0;
      background: transparent;
      color: var(--text);
      font: inherit;
      font-weight: 800;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-decoration-color: rgba(6, 182, 212, .4);
      text-underline-offset: 3px;
    }
    .inventory-service-link:hover {
      color: #67e8f9;
      text-decoration-color: rgba(103, 232, 249, .8);
    }
    .inventory-type {
      color: var(--text-muted);
      font-size: 12px;
    }
    .inventory-inline-samples {
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.4;
      max-width: 360px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .inventory-service-panel {
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,.01) 100%);
      overflow: hidden;
    }
    .inventory-service-panel .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
    }
    .inventory-service-panel .title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .inventory-service-panel .meta {
      color: var(--text-muted);
      font-size: 12px;
    }
    .inventory-service-panel .body {
      padding: 14px 16px;
    }
    .inventory-back-btn {
      border: 1px solid var(--border);
      background: var(--surface-hover);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .inventory-resource-toolbar {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .inventory-resource-toolbar input,
    .inventory-resource-toolbar select {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 7px 9px;
      font-size: 12px;
    }
    .inventory-resource-toolbar input { min-width: 280px; flex: 1; }
    .inventory-mode-switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--text-muted);
      user-select: none;
      cursor: pointer;
    }
    .inventory-mode-switch input {
      accent-color: #06b6d4;
      width: 14px;
      height: 14px;
      margin: 0;
      min-width: 14px;
    }
    .inventory-res-table-wrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .inventory-resource-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .inventory-resource-table th,
    .inventory-resource-table td {
      border-bottom: 1px solid var(--border);
      text-align: left;
      padding: 9px 10px;
      vertical-align: top;
    }
    .inventory-resource-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-muted);
      background: rgba(255,255,255,.02);
    }
    .inventory-resource-table .value {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace;
      font-size: 12px;
      word-break: break-word;
    }
    .inventory-resource-table .kind {
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .03em;
    }
    .inventory-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .inventory-chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 9px;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(255,255,255,.03);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .inventory-service-panel h4 {
      margin: 0 0 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-muted);
    }
    .inventory-resource-list {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      line-height: 1.45;
      color: var(--text);
      word-break: break-word;
      max-height: 260px;
      overflow: auto;
    }
    .inventory-source-ops {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .inventory-status-ok { color: #86efac; }
    .inventory-status-err { color: #fcd34d; }
    .inventory-status-empty { color: #fca5a5; }
    .inventory-pagination {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      padding: 8px 10px;
    }
    .inventory-pagination .left,
    .inventory-pagination .right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .inventory-pagination .info {
      color: var(--text-muted);
      font-size: 12px;
    }
    .inventory-pagination button {
      border: 1px solid var(--border);
      background: var(--surface-hover);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .inventory-pagination button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    .inventory-pagination select {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
    }
    @media (max-width: 768px) {
      .hero { padding: 48px 0 44px; }
      .hero h1 { font-size: 32px; }
      .section-pillar { padding: 28px 24px; }
      .section-pillar h2 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="container">
      <div class="hero-top">
        {% if brand and (brand.logo_web_path or brand.company_name) %}
          {% set show_brand_text = (brand.show_text if brand.show_text is not none else true) %}
          {% if brand.home_url %}
          <a class="brand-wrap" href="{{ brand.home_url }}" target="_blank" rel="noopener">
          {% else %}
          <div class="brand-wrap">
          {% endif %}
            {% if brand.logo_web_path %}
            <span class="brand-logo-frame">
              <img class="brand-logo" src="{{ brand.logo_web_path }}" alt="{{ brand.company_name if brand.company_name else 'Brand logo' }}" />
            </span>
            {% endif %}
            {% if show_brand_text and brand.company_name %}
            <span class="brand-name">{{ brand.company_name }}</span>
            {% endif %}
          {% if brand.home_url %}
          </a>
          {% else %}
          </div>
          {% endif %}
        {% endif %}
      </div>
      <button type="button" class="theme-toggle" id="theme-toggle" title="Cambiar tema claro/oscuro" aria-label="Cambiar tema">
        <span class="icon-dark" aria-hidden="true">🌙</span>
        <span class="icon-light" aria-hidden="true">☀️</span>
      </button>
      <span class="label">Well-Architected Framework{% if metadata.well_arch_version %} · v{{ metadata.well_arch_version }}{% endif %}</span>
      <h1>{{ brand.report_title if brand and brand.report_title else 'Evidence Pack' }}</h1>
      <p class="meta">
        <span>Account {{ metadata.account_id }}</span>
        <span>{{ metadata.generated_at }}</span>
      </p>
    </div>
  </header>

  <div class="tabs-wrap">
    <input type="radio" name="main-tab" id="tab-scorecard" checked>
    <input type="radio" name="main-tab" id="tab-evidence">
    <input type="radio" name="main-tab" id="tab-caf">
    <input type="radio" name="main-tab" id="tab-maturity">
    <input type="radio" name="main-tab" id="tab-phases">
    <input type="radio" name="main-tab" id="tab-inventory">
    <input type="radio" name="main-tab" id="tab-improvement-plan">
    <input type="radio" name="main-tab" id="tab-tagging">
    <div class="tab-labels">
      <label for="tab-scorecard">Visión General</label>
      <label for="tab-evidence">Paquete de Evidencias (WA Core)</label>
      <label for="tab-phases">Controles WAFR</label>
      <label for="tab-improvement-plan">Plan de Mejora</label>
      <label for="tab-caf">Adopción de Nube (CAF)</label>
      <label for="tab-maturity">Madurez de Seguridad</label>
      <label for="tab-inventory">Inventario de Activos</label>
      <label for="tab-tagging">Gobierno de Tags</label>
    </div>
    <div id="panel-scorecard" class="tab-panel">
      <div class="scorecard-hero">
        <div class="score-big"><span id="overall-score">{{ average_score }}</span><span>/5.0</span></div>
        <p class="score-subtitle">Score promedio por pilar</p>
        <div class="score-mode-toggle" role="group" aria-label="Modo de scoring por ambiente">
          <button type="button" id="score-mode-standard">DLL / No productivo</button>
          <button type="button" id="score-mode-conservative" class="is-active">Productivo</button>
        </div>
        <p class="score-mode-help">Usa <strong>DLL / No productivo</strong> para ambientes de prueba y <strong>Productivo</strong> para cuentas en operación real.</p>
        <div class="score-formula" id="score-formula-standard" style="display:none;">
          <strong>Fórmula de ponderación (DLL / No productivo):</strong><br>
          Por pilar: <code>score_pilar = redondeo(media(puntos por pregunta))</code>, con puntos: compliant=5, partially_compliant=4, not_compliant=2 (not_applicable se excluye). Límites 1–5.<br>
          Score global: <code>average_score = media(score_Operational Excellence, …, score_Sustainability)</code> (promedio simple de los 6 pilares).
        </div>
        <div class="score-formula" id="score-formula-conservative">
          <strong>Fórmula de ponderación (Productivo):</strong><br>
          Por pilar: <code>score_pilar = redondeo(score_preguntas - penalizaciones + bono)</code>.<br>
          Donde <code>score_preguntas = media(puntos por pregunta)</code>, con puntos: compliant=5, partially_compliant=3, not_compliant=1 (not_applicable se excluye).<br>
          Penalizaciones por evidencia: not_detected/service_missing=0.12, warning=0.20, negative|error=0.35 (tope 1.8). Bono positive=0.10 (tope 0.3). Límites 1–5.<br>
          Score global: <code>average_score = media(score_Operational Excellence, …, score_Sustainability)</code> (promedio simple de los 6 pilares).
        </div>
        <div class="score-radar-wrap">
          <h2>Radar de valores por pilar</h2>
          <div id="score-radar" class="score-radar"
               data-max="5"
               data-items-conservative='[
               {% for s in scorecard_list %}
                 {"name": "{{ s.name }}", "score": {{ s.score }}}{% if not loop.last %},{% endif %}
               {% endfor %}
               ]'
               data-items-standard='[
               {% for s in scorecard_list_standard %}
                 {"name": "{{ s.name }}", "score": {{ s.score }}}{% if not loop.last %},{% endif %}
               {% endfor %}
               ]'>
          </div>
        </div>
      </div>
      <div class="scorecard-grid">
        {% for p in pillar_summaries %}
        <div class="scorecard-card"
             style="--pillar-color: {{ p.color }}"
             data-pillar="{{ p.name }}"
             data-score-conservative="{{ scorecard_scores.get(p.name, 5) }}"
             data-score-standard="{{ scorecard_scores_standard.get(p.name, 5) }}">
          <div class="name">{{ p.name }}</div>
          <div class="score-row">
            <span class="score-num">{{ scorecard_scores.get(p.name, 5) }}/5</span>
            <span class="score-label">
              {% set sc = scorecard_scores.get(p.name, 5) %}
              {% if sc == 5 %}Excelente{% elif sc == 4 %}Bueno{% elif sc == 3 %}Aceptable{% elif sc == 2 %}Necesita Mejora{% else %}Crítico{% endif %}
            </span>
          </div>
          <p class="summary">{{ pillars[p.name].summary }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
    <div id="panel-caf" class="tab-panel">
      {% if caf_data and caf_data.perspectives %}
      <div class="caf-wrap">
        <article class="caf-hero">
          <h2>AWS Cloud Adoption Framework (CAF)</h2>
          <p>Vista basada en insumos técnicos del run y señales organizacionales. Los elementos marcados como <strong>Organizacional</strong> requieren definición/proceso humano.</p>
          <div class="caf-kpis">
            <div class="caf-kpi"><div class="v">{{ caf_data.summary.perspectives }}</div><div class="l">Perspectivas CAF</div></div>
            <div class="caf-kpi"><div class="v">{{ caf_data.summary.organizational_items }}</div><div class="l">Insumos Organizacionales</div></div>
            <div class="caf-kpi"><div class="v">{{ caf_data.summary.technical_items }}</div><div class="l">Insumos Técnicos</div></div>
            <div class="caf-kpi"><div class="v">{{ caf_data.summary.services_discovered }}</div><div class="l">Servicios Detectados</div></div>
            <div class="caf-kpi"><div class="v">{{ caf_data.summary.collection_success_pct }}%</div><div class="l">Éxito Recolección</div></div>
          </div>
        </article>
        <section class="caf-grid">
          {% for p in caf_data.perspectives %}
          <article class="caf-card">
            <div class="caf-card-head">
              <div class="caf-head-left">
                <span class="caf-semaphore {{ p.status }}" aria-hidden="true"></span>
                <h3>{{ p.name }}</h3>
              </div>
              <span class="caf-badge {{ p.status }}">{{ p.status_label }}</span>
            </div>
            <p class="caf-desc">{{ p.description }}</p>
            <div class="caf-item-list">
              {% for item in p["items"] %}
              <div class="caf-item">
                <div class="caf-item-top">
                  <p class="caf-item-title">
                    {{ item.title }}
                    {% if item.organizational %}<span class="caf-chip-org">Organizacional</span>{% endif %}
                  </p>
                  <span class="caf-badge {{ item.status }}">{{ item.status_label }}</span>
                </div>
                <p class="caf-item-meta"><strong>Insumo:</strong> {{ item.evidence }}</p>
                <p class="caf-item-meta">
                  <strong>Fuente:</strong>
                  {% if item.source_url %}
                  <a href="{{ item.source_url }}" target="_blank" rel="noopener">{{ item.source }}</a>
                  {% else %}
                  {{ item.source }}
                  {% endif %}
                </p>
                <p class="caf-item-meta"><strong>Acción sugerida:</strong> {{ item.action }}</p>
              </div>
              {% endfor %}
            </div>
          </article>
          {% endfor %}
        </section>
        {% if caf_data.organizational_backlog %}
        <article class="caf-org-backlog">
          <h3>Top 5 decisiones organizacionales pendientes</h3>
          <ol class="caf-org-list">
            {% for it in caf_data.organizational_backlog %}
            <li>
              <strong>[{{ it.perspective }}]</strong> {{ it.title }}
              <span class="caf-badge {{ it.status }}">{{ it.status_label }}</span>
              <br>
              Acción: {{ it.action }}
              {% if it.source %}
              <br>
              Fuente:
              {% if it.source_url %}
              <a href="{{ it.source_url }}" target="_blank" rel="noopener">{{ it.source }}</a>
              {% else %}
              {{ it.source }}
              {% endif %}
              {% endif %}
            </li>
            {% endfor %}
          </ol>
        </article>
        {% endif %}
      </div>
      {% else %}
      <div class="tab-report-content">
        <p>No hay insumos suficientes para construir la vista CAF en este run.</p>
      </div>
      {% endif %}
    </div>
    <div id="panel-maturity" class="tab-panel">
      {% if security_maturity_html %}
      <div class="tab-report-content">{{ security_maturity_html }}</div>
      {% else %}
      <div class="tab-report-placeholder">
        <p>Ejecute <code>make reports RUN_DIR=...</code> para incluir el Modelo de Madurez en Seguridad de AWS en esta vista.</p>
        <p><a href="https://maturitymodel.security.aws.dev/es/" target="_blank" rel="noopener">Modelo de Madurez en Seguridad de AWS (es)</a></p>
      </div>
      {% endif %}
    </div>
    <div id="panel-phases" class="tab-panel">
      {% if phases_data %}
      <div class="phases-wrap">
        <div class="phases-grid">
          {% set p1 = phases_data.phase_1_baseline %}
          <article class="phase-card">
            <h3>{{ p1.name }}</h3>
            <p>{{ p1.description }}</p>
            <span class="phase-status">Estado: {{ p1.status }}</span>
            <div class="phase-metrics">
              <div class="phase-kpi"><div class="v">{{ p1.metrics.coverage_pct }}%</div><div class="l">Cobertura</div></div>
              <div class="phase-kpi"><div class="v">{{ p1.metrics.confidence_pct }}%</div><div class="l">Confianza</div></div>
              <div class="phase-kpi"><div class="v">{{ p1.metrics.evaluated_controls }}/{{ p1.metrics.total_controls }}</div><div class="l">Evaluados</div></div>
              <div class="phase-kpi"><div class="v">{{ p1.metrics.not_evaluable_pct }}%</div><div class="l">No evaluable</div></div>
            </div>
          </article>
          {% set p2 = phases_data.phase_2_extended %}
          {% set p2_visible = p2 and p2.metrics and p2.metrics.total_controls|int > 0 %}
          {% if p2_visible %}
          <article class="phase-card">
            <h3>{{ p2.name }}</h3>
            <p>{{ p2.description }}</p>
            <span class="phase-status">Estado: {{ p2.status }}</span>
            <div class="phase-metrics">
              <div class="phase-kpi"><div class="v">{{ p2.metrics.coverage_pct }}%</div><div class="l">Cobertura</div></div>
              <div class="phase-kpi"><div class="v">{{ p2.metrics.confidence_pct }}%</div><div class="l">Confianza</div></div>
              <div class="phase-kpi"><div class="v">{{ p2.metrics.evaluated_controls }}/{{ p2.metrics.total_controls }}</div><div class="l">Evaluados</div></div>
              <div class="phase-kpi"><div class="v">{{ p2.metrics.lenses|length }}</div><div class="l">Lentes técnicos</div></div>
            </div>
            {% if p2.metrics.lenses %}
            <div class="phase-lenses-list">
              {% for lens in p2.metrics.lenses %}
              <div class="phase-lens-item">
                <span>{{ lens.name }}</span>
                <span class="meta">
                  {% if lens.origin == 'aws_official' %}
                  <span class="lens-origin lens-origin-official">AWS Official</span>
                  {% else %}
                  <span class="lens-origin lens-origin-custom">ECAD Custom</span>
                  {% endif %}
                </span>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </article>
          {% endif %}
          {% set p3 = phases_data.phase_3_wafr_official %}
          <article class="phase-card">
            <h3>{% if p2_visible %}{{ p3.name }}{% else %}Fase 2 - WAFR con Official Lenses{% endif %}</h3>
            <p>{{ p3.description }}</p>
            <span class="phase-status">Estado: {{ p3.status }}</span>
            <ul class="phase-ready-list">
              <li>Segmentación de workloads: {{ p3.readiness.workload_segmentation }}</li>
              <li>Selección de official lenses: {{ p3.readiness.lens_selection_by_workload }}</li>
              <li>Respuestas manuales/híbridas: {{ p3.readiness.manual_non_automatable_answers }}</li>
              <li>Gobierno de versiones de lens: {{ p3.readiness.lens_version_governance }}</li>
              <li>Workflow de revisión con owners: {{ p3.readiness.review_workflow_with_owners }}</li>
            </ul>
          </article>
        </div>
        {% if controls_catalog and controls_catalog.controls %}
        {% set wafr_controls = controls_catalog.controls %}
        <section class="wafr-explorer">
          <h3>WAFR Controls Explorer</h3>
          <div class="wafr-toolbar">
            <input id="wafr-search" type="text" placeholder="Buscar por ID, control, lógica, servicio..." />
            <select id="wafr-filter-lens">
              <option value="all">Lens: Todos</option>
              {% for lens in controls_catalog.lenses %}
              <option value="{{ lens.id }}">{{ lens.name }}</option>
              {% endfor %}
            </select>
            <select id="wafr-filter-pillar">
              <option value="all">Pilar: Todos</option>
              {% for p in wafr_controls | map(attribute='pillar') | unique | sort %}
              <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <select id="wafr-filter-status">
              <option value="all">Estado: Todos</option>
              <option value="evaluated">Evaluated</option>
              <option value="compliant">Compliant</option>
              <option value="partially_compliant">Partially compliant</option>
              <option value="not_compliant">Not compliant</option>
              <option value="not_evaluable">Not evaluable</option>
            </select>
          </div>
          <div class="wafr-table-wrap">
            <table class="wafr-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Control</th>
                  <th>Pilar</th>
                  <th>Lens</th>
                  <th>Fuente oficial</th>
                  <th>Estado</th>
                  <th>Conf.</th>
                  <th>Servicios</th>
                </tr>
              </thead>
              <tbody id="wafr-controls-body">
                {% for c in wafr_controls %}
                {% set status = c.status if c.status else ('evaluated' if c.evaluated else 'not_evaluable') %}
                <tr class="wafr-row"
                    data-search="{{ c.control_id|lower }} {{ c.title|lower }} {{ c.pillar|lower }} {{ c.lens_name|lower }} {{ c.source_reference|default('')|lower }} {{ c.evaluation_logic|default('')|lower }} {{ (c.related_services|default([])|join(' '))|lower }}"
                    data-lens="{{ c.lens_id }}"
                    data-pillar="{{ c.pillar }}"
                    data-status="{{ status }}"
                    data-control-json='{{ c|tojson|e }}'>
                  <td>{{ c.control_id }}</td>
                  <td><button type="button" class="wafr-row-btn">{{ c.title }}</button></td>
                  <td>{{ c.pillar }}</td>
                  <td>{{ c.lens_name }}</td>
                  <td>
                    {% if c.source_url_detail or c.source_url %}
                    <a href="{{ c.source_url_detail if c.source_url_detail else c.source_url }}" target="_blank" rel="noopener">
                      {{ c.source_reference if c.source_reference else 'AWS official' }}
                    </a>
                    {% else %}
                    {{ c.source_reference if c.source_reference else '—' }}
                    {% endif %}
                  </td>
                  <td><span class="wafr-badge {{ status }}">{{ status }}</span></td>
                  <td>{{ (c.confidence * 100)|round(1) if c.confidence is not none else 0 }}%</td>
                  <td>{{ c.related_services|default([])|length }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="wafr-detail" id="wafr-control-detail">
            <h4>Detalle del control</h4>
            <div class="wafr-detail-grid">
              <div>ID: <span class="v" id="wafr-d-id">Seleccione un control</span></div>
              <div>Estado: <span class="v" id="wafr-d-status">—</span></div>
              <div>Pilar: <span class="v" id="wafr-d-pillar">—</span></div>
              <div>Lens: <span class="v" id="wafr-d-lens">—</span></div>
              <div>Confianza: <span class="v" id="wafr-d-confidence">—</span></div>
              <div>Evidencia: <span class="v" id="wafr-d-evidence">—</span></div>
              <div>Fuente: <span class="v" id="wafr-d-source">—</span></div>
              <div>Ref. oficial: <span class="v" id="wafr-d-ref">—</span></div>
              <div style="grid-column: 1 / -1;">Lógica: <span class="v" id="wafr-d-logic">—</span></div>
              <div style="grid-column: 1 / -1;">Traza de evidencia: <span class="v" id="wafr-d-evcount">—</span></div>
            </div>
            <div class="wafr-chips" id="wafr-d-services"></div>
            <div class="wafr-chips" id="wafr-d-detected"></div>
            <div class="wafr-chips" id="wafr-d-missing"></div>
          </div>
          <div class="inventory-pagination">
            <div class="left">
              <span class="info" id="wafr-visible-count"></span>
            </div>
          </div>
          <details class="wafr-legend">
            <summary>Convención de estados</summary>
            <div class="wafr-legend-content">
              <ul class="wafr-legend-list">
                <li><span class="wafr-badge compliant">compliant</span><span>Control cumple según evidencia recolectada.</span></li>
                <li><span class="wafr-badge partially_compliant">partially_compliant</span><span>Cumplimiento parcial; hay brechas o faltantes.</span></li>
                <li><span class="wafr-badge not_compliant">not_compliant</span><span>No cumple o existe hallazgo crítico/negativo.</span></li>
                <li><span class="wafr-badge evaluated">evaluated</span><span>Fue evaluado automáticamente, pero no clasifica en cumplimiento directo.</span></li>
                <li><span class="wafr-badge not_evaluable">not_evaluable</span><span>Requiere validación manual o no hay señales suficientes para evaluar.</span></li>
              </ul>
            </div>
          </details>
        </section>
        {% endif %}
      </div>
      {% else %}
      <div class="tab-report-placeholder">
        <p>Ejecute <code>make reports RUN_DIR=...</code> para construir la vista por fases.</p>
      </div>
      {% endif %}
    </div>
    <div id="panel-inventory" class="tab-panel">
      {% if inventory_data %}
      <div class="inventory-wrap">
        <div class="inventory-kpis">
          <div class="coverage-kpi"><div class="v">{{ inventory_data.summary.services_total }}</div><div class="l">Servicios Totales</div></div>
          <div class="coverage-kpi"><div class="v">{{ inventory_data.summary.services_with_data }}</div><div class="l">Con Datos</div></div>
          <div class="coverage-kpi"><div class="v">{{ inventory_data.summary.services_with_errors }}</div><div class="l">Con Errores</div></div>
          <div class="coverage-kpi"><div class="v">{{ inventory_data.summary.services_without_data }}</div><div class="l">Sin Datos</div></div>
        </div>
        <section id="inventory-list-view" class="inventory-list-view">
          <div class="inventory-toolbar">
            <label for="inventory-search">Inventario Explorer</label>
            <input id="inventory-search" type="text" placeholder="Buscar servicio, recurso, ARN, ID..." />
            <select id="inventory-status-filter">
              <option value="all">Estado: Todos</option>
              <option value="con_datos">Con datos</option>
              <option value="errores">Con errores</option>
              <option value="sin_datos">Sin datos</option>
            </select>
            <select id="inv-page-size-consolidado">
              <option value="10">10 / página</option>
              <option value="25" selected>25 / página</option>
              <option value="50">50 / página</option>
              <option value="100">100 / página</option>
            </select>
          </div>
          <div class="inventory-explorer">
            <table class="inventory-main-table">
              <thead>
                <tr>
                  <th>Servicio</th>
                  <th>Tipo principal</th>
                  <th>Estado</th>
                  <th>Recursos</th>
                  <th>Regiones</th>
                  <th>Cobertura API</th>
                  <th>Muestras detectadas</th>
                </tr>
              </thead>
              <tbody id="inventory-table-body">
                {% for row in inventory_data.rows %}
                <tr class="inventory-row inventory-row-consolidado"
                    data-service="{{ row.service }}"
                    data-status="{{ row.status }}"
                    data-resource-type="{{ row.resource_type }}"
                    data-search="{{ row.service|lower }} {{ row.resource_type|lower }} {% for s in row.resource_samples_real[:3] %}{{ s.value|lower }} {% endfor %} {% for s in row.resource_samples_catalog[:3] %}{{ s.value|lower }} {% endfor %}"
                    data-samples-real-json='{{ row.resource_samples_real|tojson|e }}'
                    data-samples-catalog-json='{{ row.resource_samples_catalog|tojson|e }}'
                    data-ops-real-json='{{ row.sample_source_ops_real|tojson|e }}'
                    data-ops-catalog-json='{{ row.sample_source_ops_catalog|tojson|e }}'
                    data-subcategories-real-json='{{ row.resource_subcategories_real|tojson|e }}'
                    data-subcategories-catalog-json='{{ row.resource_subcategories_catalog|tojson|e }}'>
                  <td class="inventory-service">
                    <button type="button" class="inventory-service-link" data-open-service="{{ row.service }}">{{ row.service }}</button>
                  </td>
                  <td class="inventory-type">{{ row.resource_type }}</td>
                  <td>
                    {% if row.status == 'con_datos' %}
                    <span class="inventory-status-ok">Con datos</span>
                    {% elif row.status == 'errores' %}
                    <span class="inventory-status-err">Con errores</span>
                    {% else %}
                    <span class="inventory-status-empty">Sin datos</span>
                    {% endif %}
                  </td>
                  <td>{{ row.resources }}</td>
                  <td>{{ row.regions }}</td>
                  <td>{{ row.operations_ok }}/{{ row.operations_total }}</td>
                  <td class="inventory-inline-samples">
                    {% if row.resource_samples_preview %}
                      {% for s in row.resource_samples_preview %}{{ s.value }}{% if not loop.last %}, {% endif %}{% endfor %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="inventory-pagination">
            <div class="left">
              <button type="button" id="inv-prev-consolidado">Anterior</button>
              <button type="button" id="inv-next-consolidado">Siguiente</button>
              <span class="info" id="inv-page-info-consolidado"></span>
            </div>
          </div>
        </section>

        <section id="inventory-service-view" class="inventory-service-view">
          <article class="inventory-service-panel">
            <div class="head">
              <button type="button" class="inventory-back-btn" id="inv-back-to-list">← Volver a servicios</button>
              <div class="title" id="inv-service-title">Servicio</div>
              <div class="meta" id="inv-service-meta">—</div>
            </div>
            <div class="body">
              <div class="inventory-resource-toolbar">
                <input id="inv-service-search" type="text" placeholder="Buscar recurso dentro del servicio..." />
                <select id="inv-service-page-size">
                  <option value="25">25 / página</option>
                  <option value="50" selected>50 / página</option>
                  <option value="100">100 / página</option>
                </select>
                <label class="inventory-mode-switch">
                  <input id="inv-service-show-no-arn" type="checkbox" />
                  <span>Mostrar sin ARN</span>
                </label>
              </div>
              <div class="inventory-chips" id="inv-service-subcats"></div>
              <div class="inventory-res-table-wrap">
                <table class="inventory-resource-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Nombre</th>
                      <th>ARN</th>
                      <th>Categoría ARN</th>
                      <th>Subcategoría</th>
                      <th>Tipo</th>
                    </tr>
                  </thead>
                  <tbody id="inv-service-resource-body"></tbody>
                </table>
              </div>
              <div class="inventory-pagination">
                <div class="left">
                  <button type="button" id="inv-service-prev">Anterior</button>
                  <button type="button" id="inv-service-next">Siguiente</button>
                  <span class="info" id="inv-service-page-info"></span>
                </div>
              </div>
              <h4>Operaciones fuente</h4>
              <div class="inventory-source-ops" id="inv-service-ops">—</div>
            </div>
          </article>
        </section>
      </div>
      {% else %}
      <div class="tab-report-placeholder">
        <p>Ejecute <code>make reports RUN_DIR=...</code> para incluir el inventario de servicios y recursos en esta vista.</p>
      </div>
      {% endif %}
    </div>
    <div id="panel-improvement-plan" class="tab-panel">
      {% if improvement_plan_data %}
      <div class="remediation-wrap">
        {% set all_items = improvement_plan_data.pronta + improvement_plan_data.mri %}
        <section class="remediation-hero">
          <h2>Plan de Remediación Guiada</h2>
          <p class="remediation-meta">Playbook accionable consolidado desde Hallazgos, Evidence Pack y Modelo de Madurez.</p>
          <div class="remediation-stats">
            <div class="remediation-stat"><div class="v">{{ improvement_plan_data.summary.total }}</div><div class="l">Acciones Totales</div></div>
            <div class="remediation-stat"><div class="v">{{ improvement_plan_data.summary.pronta_count }}</div><div class="l">Pronta Solución (30 días)</div></div>
            <div class="remediation-stat"><div class="v">{{ improvement_plan_data.summary.mri_count }}</div><div class="l">MRI (60+ días)</div></div>
          </div>
        </section>
        <section class="remediation-toolbar">
          <div class="remediation-filters">
            <input id="rem-filter-search" type="text" placeholder="Buscar por ID, título, dominio..." />
            <select id="rem-filter-phase">
              <option value="all">Fase: Todas</option>
              <option value="pronta">Pronta solución</option>
              <option value="mri">MRI</option>
            </select>
            <select id="rem-filter-domain">
              <option value="all">Dominio: Todos</option>
              {% for v in all_items | map(attribute='domain') | unique | sort %}
              <option value="{{ v }}">{{ v }}</option>
              {% endfor %}
            </select>
            <select id="rem-filter-source">
              <option value="all">Origen: Todos</option>
              {% for v in all_items | map(attribute='source') | unique | sort %}
              <option value="{{ v }}">{{ v }}</option>
              {% endfor %}
            </select>
            <select id="rem-filter-risk">
              <option value="all">Riesgo: Todos</option>
              <option value="Alto">Alto</option>
              <option value="Medio">Medio</option>
              <option value="Bajo">Bajo</option>
            </select>
            <select id="rem-filter-owner">
              <option value="all">Owner: Todos</option>
              {% for v in all_items | map(attribute='owner_role') | unique | sort %}
              <option value="{{ v }}">{{ v }}</option>
              {% endfor %}
            </select>
            <select id="rem-filter-sla">
              <option value="all">SLA: Todos</option>
              <option value="30">30 días</option>
              <option value="60">60+ días</option>
            </select>
          </div>
          <div class="remediation-actions">
            <div class="left">
              <button type="button" id="rem-filter-clear">Limpiar filtros</button>
              <button type="button" id="rem-export-csv">Exportar visible CSV</button>
              <button type="button" id="rem-export-json">Exportar visible JSON</button>
            </div>
            <div class="remediation-count" id="rem-visible-count"></div>
          </div>
        </section>

        <section class="remediation-phase">
          <h3>Pronta solución (30 días)</h3>
          <div class="remediation-grid">
            {% for item in improvement_plan_data.pronta %}
            <details class="remediation-card">
              <summary
                data-phase="pronta"
                data-id="{{ item.id }}"
                data-title="{{ item.title }}"
                data-domain="{{ item.domain }}"
                data-source="{{ item.source }}"
                data-risk="{{ item.risk_level }}"
                data-owner="{{ item.owner_role }}"
                data-sla="{{ item.target_days }}"
                data-recommendation="{{ item.recommendation }}"
                data-search="{{ (item.id ~ ' ' ~ item.title ~ ' ' ~ item.domain ~ ' ' ~ item.source ~ ' ' ~ item.owner_role) | lower }}">
                <div class="remediation-title">{{ item.title }} ({{ item.id }})</div>
                <div class="remediation-badges">
                  <span class="r-badge">{{ item.domain }}</span>
                  <span class="r-badge">{{ item.source }}</span>
                  <span class="r-badge r-risk-{{ 'high' if item.risk_level == 'Alto' else ('medium' if item.risk_level == 'Medio' else 'low') }}">Riesgo {{ item.risk_level }}</span>
                  <span class="r-badge">SLA {{ item.target_days }}d</span>
                  <span class="r-badge">{{ item.owner_role }}</span>
                </div>
              </summary>
              <div class="remediation-body">
                <div class="remediation-columns">
                  <div class="remediation-box">
                    <h4>Objetivo de Control</h4>
                    <p>{{ item.control_objective }}</p>
                  </div>
                  <div class="remediation-box">
                    <h4>Contexto</h4>
                    <p><strong>Impacto:</strong> {{ item.impact }}</p>
                    <p><strong>Estado actual:</strong> {{ item.description }}</p>
                    <p><strong>Recomendación:</strong> {{ item.recommendation }}</p>
                  </div>
                </div>
                <div class="remediation-columns" style="margin-top: 12px;">
                  <div class="remediation-box">
                    <h4>Pasos de Remediación</h4>
                    <ol>
                      {% for step in item.remediation_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                  <div class="remediation-box">
                    <h4>Validación</h4>
                    <ol>
                      {% for step in item.validation_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                  <div class="remediation-box">
                    <h4>Rollback</h4>
                    <ol>
                      {% for step in item.rollback_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                </div>
                <div class="remediation-columns" style="margin-top: 12px;">
                  <div class="remediation-box">
                    <h4>Criterio de Cierre</h4>
                    <ul>
                      {% for c in item.success_criteria %}<li>{{ c }}</li>{% endfor %}
                    </ul>
                  </div>
                  <div class="remediation-box remediation-links">
                    <h4>Estándares y Guías</h4>
                    <ul>
                      {% for ref in item.standard_refs %}
                      <li><a href="{{ ref.url }}" target="_blank" rel="noopener">{{ ref.name }}</a></li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </details>
            {% endfor %}
          </div>
        </section>

        <section class="remediation-phase">
          <h3>MRI (60+ días)</h3>
          <div class="remediation-grid">
            {% for item in improvement_plan_data.mri %}
            <details class="remediation-card">
              <summary
                data-phase="mri"
                data-id="{{ item.id }}"
                data-title="{{ item.title }}"
                data-domain="{{ item.domain }}"
                data-source="{{ item.source }}"
                data-risk="{{ item.risk_level }}"
                data-owner="{{ item.owner_role }}"
                data-sla="{{ item.target_days }}"
                data-recommendation="{{ item.recommendation }}"
                data-search="{{ (item.id ~ ' ' ~ item.title ~ ' ' ~ item.domain ~ ' ' ~ item.source ~ ' ' ~ item.owner_role) | lower }}">
                <div class="remediation-title">{{ item.title }} ({{ item.id }})</div>
                <div class="remediation-badges">
                  <span class="r-badge">{{ item.domain }}</span>
                  <span class="r-badge">{{ item.source }}</span>
                  <span class="r-badge r-risk-{{ 'high' if item.risk_level == 'Alto' else ('medium' if item.risk_level == 'Medio' else 'low') }}">Riesgo {{ item.risk_level }}</span>
                  <span class="r-badge">SLA {{ item.target_days }}d</span>
                  <span class="r-badge">{{ item.owner_role }}</span>
                </div>
              </summary>
              <div class="remediation-body">
                <div class="remediation-columns">
                  <div class="remediation-box">
                    <h4>Objetivo de Control</h4>
                    <p>{{ item.control_objective }}</p>
                  </div>
                  <div class="remediation-box">
                    <h4>Contexto</h4>
                    <p><strong>Impacto:</strong> {{ item.impact }}</p>
                    <p><strong>Estado actual:</strong> {{ item.description }}</p>
                    <p><strong>Recomendación:</strong> {{ item.recommendation }}</p>
                  </div>
                </div>
                <div class="remediation-columns" style="margin-top: 12px;">
                  <div class="remediation-box">
                    <h4>Pasos de Remediación</h4>
                    <ol>
                      {% for step in item.remediation_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                  <div class="remediation-box">
                    <h4>Validación</h4>
                    <ol>
                      {% for step in item.validation_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                  <div class="remediation-box">
                    <h4>Rollback</h4>
                    <ol>
                      {% for step in item.rollback_steps %}<li>{{ step }}</li>{% endfor %}
                    </ol>
                  </div>
                </div>
                <div class="remediation-columns" style="margin-top: 12px;">
                  <div class="remediation-box">
                    <h4>Criterio de Cierre</h4>
                    <ul>
                      {% for c in item.success_criteria %}<li>{{ c }}</li>{% endfor %}
                    </ul>
                  </div>
                  <div class="remediation-box remediation-links">
                    <h4>Estándares y Guías</h4>
                    <ul>
                      {% for ref in item.standard_refs %}
                      <li><a href="{{ ref.url }}" target="_blank" rel="noopener">{{ ref.name }}</a></li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </details>
            {% endfor %}
          </div>
        </section>
      </div>
      {% elif improvement_plan_html %}
      <div class="tab-report-content">{{ improvement_plan_html }}</div>
      {% else %}
      <div class="tab-report-placeholder">
        <p>Ejecute <code>make reports RUN_DIR=...</code> para incluir el Plan de mejoras (Well-Architected Improvement Plan) en esta vista.</p>
      </div>
      {% endif %}
    </div>
    <div id="panel-tagging" class="tab-panel">
      {% if tagging_html %}
      <div class="tab-report-content">{{ tagging_html }}</div>
      {% else %}
      <div class="tab-report-placeholder">
        <p>Ejecute <code>make reports RUN_DIR=...</code> para incluir el reporte de tags por servicio.</p>
        <p>Asegúrate de que la política IAM incluya <code>tag:GetResources</code>, <code>tag:GetTagKeys</code> y <code>tag:GetTagValues</code>.</p>
      </div>
      {% endif %}
    </div>
    <div id="panel-evidence" class="tab-panel">
      <div class="container" style="padding-bottom: 24px;">
        {% if coverage_report and coverage_report.global %}
        <article class="coverage-global">
          <h3>Cobertura Global de Controles WAFR (WA Core + WAFR Extended)</h3>
          <div class="coverage-kpis">
            <div class="coverage-kpi"><div class="v">{{ coverage_report.global.coverage_pct }}%</div><div class="l">Cobertura</div></div>
            <div class="coverage-kpi"><div class="v">{{ coverage_report.global.confidence_pct }}%</div><div class="l">Confianza</div></div>
            <div class="coverage-kpi"><div class="v">{{ coverage_report.global.in_scope_controls }}</div><div class="l">Controles en Alcance</div></div>
            <div class="coverage-kpi"><div class="v">{{ coverage_report.global.lenses_evaluated }}</div><div class="l">Lentes Evaluados</div></div>
            <div class="coverage-kpi"><div class="v">{{ coverage_report.global.services_evaluated }}</div><div class="l">Servicios Evaluados</div></div>
          </div>
        </article>
        {% endif %}
        <article class="coverage-global" style="margin-bottom: 14px;">
          <h3>Paquete de Evidencias Well-Architected Core (WA Core)</h3>
          <p class="coverage-foot" style="margin-top:0;">
            Las tarjetas por pilar y el detalle de preguntas/evidencias de esta sección corresponden a la evaluación base WA Core.
            La evaluación extendida de controles oficiales WAFR se presenta en la pestaña <strong>Controles WAFR</strong>.
          </p>
        </article>
        <div class="pillar-cards">
          {% for p in pillar_summaries %}
          <a class="pillar-card" href="#pillar-{{ p.slug }}" style="--pillar-color: {{ p.color }}">
            <span class="pillar-hero-icon">{{ pillar_icons[p.name] }}</span>
            <span class="name">{{ p.name }}</span>
            <span class="badge badge-{{ p.badge_class }}">{{ p.status_label }}</span>
            <p class="summary">{{ p.summary }}</p>
          </a>
          {% endfor %}
        </div>
      </div>
  <nav class="nav-pillars">
    <div class="container">
      {% for p in pillar_summaries %}
      <a href="#pillar-{{ p.slug }}" data-color style="--pillar-color: {{ p.color }}">{{ p.name }}</a>
      {% endfor %}
    </div>
  </nav>

  <main>
    <div class="container">
    {% for p in pillar_summaries %}
    <section id="pillar-{{ p.slug }}" class="section-pillar" style="--pillar-color: {{ p.color }}">
      <div class="pillar-section-icon">{{ pillar_icons[p.name] }}</div>
      <h2>{{ p.name }}</h2>
      <p class="pillar-summary">{{ pillars[p.name].summary }}</p>
      {% if coverage_report and coverage_report.pillars and coverage_report.pillars.get(p.name) %}
      {% set cov = coverage_report.pillars.get(p.name) %}
      <article class="coverage-card" style="margin-bottom:16px;">
        <h3>Cobertura de Evaluación</h3>
        <div class="coverage-metric">
          <div class="head"><span>Cobertura</span><span>{{ cov.coverage_pct }}%</span></div>
          <div class="coverage-bar cover"><span style="width: {{ cov.coverage_pct }}%;"></span></div>
        </div>
        <div class="coverage-metric">
          <div class="head"><span>Confianza</span><span>{{ cov.confidence_pct }}%</span></div>
          <div class="coverage-bar conf"><span style="width: {{ cov.confidence_pct }}%;"></span></div>
        </div>
        <div class="coverage-metric">
          <div class="head"><span>No evaluable</span><span>{{ cov.not_evaluable_pct }}%</span></div>
          <div class="coverage-bar ne"><span style="width: {{ cov.not_evaluable_pct }}%;"></span></div>
        </div>
        <p class="coverage-foot">Controles evaluados: {{ cov.evaluated_controls }}/{{ cov.total_controls }} (no evaluables: {{ cov.not_evaluable_controls }}).</p>
        {% if cov.controls_by_lens %}
        <div class="coverage-lens-tags">
          {% for lid, ccount in cov.controls_by_lens.items() %}
          {% if coverage_report.lenses and coverage_report.lenses.get(lid) %}
          <span class="coverage-lens-tag">
            {{ coverage_report.lenses.get(lid).name }}: {{ ccount }}
            {% if coverage_report.lenses.get(lid).origin == 'aws_official' %}
            <span class="lens-origin lens-origin-official">AWS Official</span>
            {% else %}
            <span class="lens-origin lens-origin-custom">ECAD Custom</span>
            {% endif %}
          </span>
          {% else %}
          <span class="coverage-lens-tag">{{ lid }}: {{ ccount }}</span>
          {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </article>
      {% endif %}
      <div class="accordion">
        {% for q in pillars[p.name].well_architected_questions %}
        <details>
          <summary>
            <span class="q-id">{{ q.id }}</span>
            <span>{{ q.question }}</span>
            <span class="badge badge-{{ q.badge_class }}">{{ q.compliance_label }}</span>
          </summary>
          <div class="content">
            <div class="compliance-msg status-{{ q.compliance_class }}">{{ q.compliance.message }}</div>
            {% if q.compliance.detected_services or q.compliance.missing_services %}
            <p><strong>Servicios evaluados</strong></p>
            {% if q.compliance.detected_services %}
            <p class="servicios-list"><strong>Detectados ({{ q.compliance.detected_services|length }}):</strong> {{ q.compliance.detected_services|join(', ') }}</p>
            {% endif %}
            {% if q.compliance.missing_services %}
            <p class="servicios-list missing"><strong>No detectados ({{ q.compliance.missing_services|length }}):</strong> {{ q.compliance.missing_services|join(', ') }}</p>
            {% endif %}
            {% endif %}
            {% if q.related_evidences %}
            <p><strong>Evidencias</strong></p>
            <ul class="evidences">
              {% for ev in q.related_evidences %}
              <li class="ev-{{ ev.status_class }}">
                {% if ev.type == 'finding' %}{{ ev.finding_label }}{% else %}{{ ev.description }}{% endif %}
                {% if ev.gap %}<br><em>Gap: {{ ev.gap }}</em>{% endif %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if q.best_practices %}
            <p><strong>Mejores prácticas</strong></p>
            <ul class="practices">
              {% for bp in q.best_practices %}<li>{{ bp.practice }}</li>{% endfor %}
            </ul>
            {% endif %}
          </div>
        </details>
        {% endfor %}
      </div>
    </section>
    {% endfor %}
    </div>
  </main>
    </div>
  </div>

  <footer class="footer">
    <div class="container">AWS Cloud Architecture Diagnostic (ECAD)</div>
  </footer>
  <script>
    (function() {
      var KEY = 'ecad-theme';
      var root = document.documentElement;
      function setTheme(val) {
        root.setAttribute('data-theme', val || 'dark');
        if (typeof localStorage !== 'undefined') try { localStorage.setItem(KEY, val || 'dark'); } catch (e) {}
      }
      function getPreferred() {
        try { return localStorage.getItem(KEY); } catch (e) { return null; }
      }
      function prefersLight() {
        try { return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches; } catch (e) { return false; }
      }
      var stored = getPreferred();
      if (stored) setTheme(stored);
      else if (prefersLight()) setTheme('light');
      else setTheme('dark');
      var btn = document.getElementById('theme-toggle');
      if (btn) btn.addEventListener('click', function() {
        var next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        setTheme(next);
      });

      // Radar chart en Scorecard
      function renderScoreRadar(mode) {
        var el = document.getElementById('score-radar');
        if (!el) return;
        var raw = el.getAttribute(mode === 'standard' ? 'data-items-standard' : 'data-items-conservative') || '[]';
        var items;
        try {
          items = JSON.parse(raw);
        } catch (e) {
          return;
        }
        if (!items || !items.length) return;
        var max = parseFloat(el.getAttribute('data-max') || '5') || 5;
        var size = 260;
        var cx = size / 2;
        var cy = size / 2;
        var radius = size * 0.35;
        var levels = 5;
        var n = items.length;
        var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#38bdf8';

        function point(angle, r) {
          return {
            x: cx + r * Math.cos(angle),
            y: cy + r * Math.sin(angle),
          };
        }

        var svgParts = [];
        svgParts.push('<svg viewBox="0 0 ' + size + ' ' + size + '" xmlns="http://www.w3.org/2000/svg">');

        // Grid (polígonos concéntricos)
        for (var level = 1; level <= levels; level++) {
          var r = (radius * level) / levels;
          var pts = [];
          for (var i = 0; i < n; i++) {
            var angle = -Math.PI / 2 + (2 * Math.PI * i) / n;
            var p = point(angle, r);
            pts.push(p.x.toFixed(1) + ',' + p.y.toFixed(1));
          }
          svgParts.push('<polygon class="score-radar-grid" points="' + pts.join(' ') + '"/>');
        }

        // Ejes y etiquetas
        for (var j = 0; j < n; j++) {
          var a = -Math.PI / 2 + (2 * Math.PI * j) / n;
          var end = point(a, radius);
          svgParts.push('<line class="score-radar-axis" x1="' + cx + '" y1="' + cy + '" x2="' + end.x.toFixed(1) + '" y2="' + end.y.toFixed(1) + '"/>');
          var labelPoint = point(a, radius + 20);
          var name = (items[j].name || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          svgParts.push('<text class="score-radar-label" x="' + labelPoint.x.toFixed(1) + '" y="' + labelPoint.y.toFixed(1) + '" text-anchor="middle">' + name + '</text>');
        }

        // Polígono de datos
        var dataPts = [];
        for (var k = 0; k < n; k++) {
          var item = items[k];
          var val = Math.max(0, Math.min(max, parseFloat(item.score || 0)));
          var rr = (val / max) * radius;
          var ang = -Math.PI / 2 + (2 * Math.PI * k) / n;
          var dp = point(ang, rr);
          dataPts.push(dp.x.toFixed(1) + ',' + dp.y.toFixed(1));
        }
        svgParts.push('<polygon class="score-radar-polygon" points="' + dataPts.join(' ') + '" style="stroke:' + accent + '; fill:' + accent + ';"/>');

        svgParts.push('</svg>');
        el.innerHTML = svgParts.join('');
      }

      function scoreLabel(score) {
        if (score >= 5) return 'Excelente';
        if (score === 4) return 'Bueno';
        if (score === 3) return 'Aceptable';
        if (score === 2) return 'Necesita Mejora';
        return 'Crítico';
      }

      function applyScoreMode(mode) {
        var selected = (mode === 'standard') ? 'standard' : 'conservative';
        var avg = selected === 'standard' ? '{{ average_score_standard }}' : '{{ average_score }}';
        var avgEl = document.getElementById('overall-score');
        if (avgEl) avgEl.textContent = avg;

        var standardBtn = document.getElementById('score-mode-standard');
        var conservativeBtn = document.getElementById('score-mode-conservative');
        if (standardBtn && conservativeBtn) {
          standardBtn.classList.toggle('is-active', selected === 'standard');
          conservativeBtn.classList.toggle('is-active', selected === 'conservative');
        }

        var fStd = document.getElementById('score-formula-standard');
        var fCon = document.getElementById('score-formula-conservative');
        if (fStd && fCon) {
          fStd.style.display = selected === 'standard' ? 'block' : 'none';
          fCon.style.display = selected === 'conservative' ? 'block' : 'none';
        }

        var cards = document.querySelectorAll('.scorecard-card');
        cards.forEach(function(card) {
          var scoreRaw = card.getAttribute(selected === 'standard' ? 'data-score-standard' : 'data-score-conservative');
          var score = parseInt(scoreRaw || '0', 10);
          var numEl = card.querySelector('.score-num');
          var labelEl = card.querySelector('.score-label');
          if (numEl) numEl.textContent = score + '/5';
          if (labelEl) labelEl.textContent = scoreLabel(score);
        });

        renderScoreRadar(selected);
        try { localStorage.setItem('ecad-score-mode', selected); } catch (e) {}
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          var standardBtn = document.getElementById('score-mode-standard');
          var conservativeBtn = document.getElementById('score-mode-conservative');
          if (standardBtn) standardBtn.addEventListener('click', function() { applyScoreMode('standard'); });
          if (conservativeBtn) conservativeBtn.addEventListener('click', function() { applyScoreMode('conservative'); });
          var preferred = 'conservative';
          try { preferred = localStorage.getItem('ecad-score-mode') || 'conservative'; } catch (e) {}
          applyScoreMode(preferred);
          initRemediationFilters();
          initWafrControls();
          initInventoryPagination();
        });
      } else {
        var standardBtn = document.getElementById('score-mode-standard');
        var conservativeBtn = document.getElementById('score-mode-conservative');
        if (standardBtn) standardBtn.addEventListener('click', function() { applyScoreMode('standard'); });
        if (conservativeBtn) conservativeBtn.addEventListener('click', function() { applyScoreMode('conservative'); });
        var preferred = 'conservative';
        try { preferred = localStorage.getItem('ecad-score-mode') || 'conservative'; } catch (e) {}
        applyScoreMode(preferred);
        initRemediationFilters();
        initWafrControls();
        initInventoryPagination();
      }

      function initWafrControls() {
        var body = document.getElementById('wafr-controls-body');
        if (!body) return;
        var rows = Array.prototype.slice.call(body.querySelectorAll('.wafr-row'));
        if (!rows.length) return;

        var q = document.getElementById('wafr-search');
        var lens = document.getElementById('wafr-filter-lens');
        var pillar = document.getElementById('wafr-filter-pillar');
        var status = document.getElementById('wafr-filter-status');
        var count = document.getElementById('wafr-visible-count');
        var dId = document.getElementById('wafr-d-id');
        var dStatus = document.getElementById('wafr-d-status');
        var dPillar = document.getElementById('wafr-d-pillar');
        var dLens = document.getElementById('wafr-d-lens');
        var dConfidence = document.getElementById('wafr-d-confidence');
        var dEvidence = document.getElementById('wafr-d-evidence');
        var dSource = document.getElementById('wafr-d-source');
        var dRef = document.getElementById('wafr-d-ref');
        var dLogic = document.getElementById('wafr-d-logic');
        var dEvCount = document.getElementById('wafr-d-evcount');
        var dServices = document.getElementById('wafr-d-services');
        var dDetected = document.getElementById('wafr-d-detected');
        var dMissing = document.getElementById('wafr-d-missing');
        if (!q || !lens || !pillar || !status || !count || !dId || !dStatus || !dPillar || !dLens || !dConfidence || !dEvidence || !dSource || !dRef || !dLogic || !dEvCount || !dServices || !dDetected || !dMissing) return;

        function txt(v) { return String(v || ''); }
        function normalize(v) { return txt(v).toLowerCase(); }
        function parseControl(row) {
          try {
            return JSON.parse(row.getAttribute('data-control-json') || '{}');
          } catch (e) {
            return {};
          }
        }
        function addChips(container, title, items) {
          container.innerHTML = '';
          var list = Array.isArray(items) ? items : [];
          if (!list.length) {
            var empty = document.createElement('span');
            empty.className = 'wafr-chip';
            empty.textContent = title + ': —';
            container.appendChild(empty);
            return;
          }
          list.forEach(function(item) {
            var chip = document.createElement('span');
            chip.className = 'wafr-chip';
            chip.textContent = title + ': ' + String(item);
            container.appendChild(chip);
          });
        }
        function showDetail(control) {
          dId.textContent = txt(control.control_id || '—');
          dStatus.textContent = txt(control.status || (control.evaluated ? 'evaluated' : 'not_evaluable') || '—');
          dPillar.textContent = txt(control.pillar || '—');
          dLens.textContent = txt(control.lens_name || control.lens_id || '—');
          var conf = control.confidence;
          dConfidence.textContent = (typeof conf === 'number') ? (Math.round(conf * 1000) / 10) + '%' : '—';
          dEvidence.textContent = txt(control.evidence_level || '—');
          dRef.textContent = txt(control.source_reference || '—');
          dSource.innerHTML = '—';
          if (control && (control.source_url_detail || control.source_url)) {
            var a = document.createElement('a');
            a.href = String(control.source_url_detail || control.source_url);
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = txt(control.source_label || 'AWS official');
            dSource.innerHTML = '';
            dSource.appendChild(a);
          }
          dLogic.textContent = txt(control.evaluation_logic || '—');
          var evTrace = Array.isArray(control.evidence_trace) ? control.evidence_trace : [];
          dEvCount.textContent = evTrace.length ? (evTrace.length + ' evidencias relacionadas') : 'Sin evidencia relacionada';
          addChips(dServices, 'Servicio', control.related_services || []);
          addChips(dDetected, 'Detectado', control.detected_services || []);
          addChips(dMissing, 'Faltante', control.missing_services || []);
        }
        function visibleRows() {
          var qq = normalize(q.value.trim());
          var lensVal = lens.value || 'all';
          var pillarVal = pillar.value || 'all';
          var statusVal = status.value || 'all';
          return rows.filter(function(row) {
            if (lensVal !== 'all' && row.getAttribute('data-lens') !== lensVal) return false;
            if (pillarVal !== 'all' && row.getAttribute('data-pillar') !== pillarVal) return false;
            if (statusVal !== 'all' && row.getAttribute('data-status') !== statusVal) return false;
            if (!qq) return true;
            return normalize(row.getAttribute('data-search')).indexOf(qq) >= 0;
          });
        }
        function render() {
          var vis = visibleRows();
          rows.forEach(function(row) { row.style.display = 'none'; row.classList.remove('is-selected'); });
          vis.forEach(function(row) { row.style.display = ''; });
          count.textContent = vis.length + ' controles visibles';
          if (vis.length) {
            vis[0].classList.add('is-selected');
            showDetail(parseControl(vis[0]));
          } else {
            showDetail({});
          }
        }

        rows.forEach(function(row) {
          var btn = row.querySelector('.wafr-row-btn');
          var onSelect = function(ev) {
            if (ev) {
              ev.preventDefault();
              ev.stopPropagation();
            }
            rows.forEach(function(r) { r.classList.remove('is-selected'); });
            row.classList.add('is-selected');
            showDetail(parseControl(row));
          };
          row.addEventListener('click', onSelect);
          if (btn) btn.addEventListener('click', onSelect);
        });
        [q, lens, pillar, status].forEach(function(el) {
          el.addEventListener('input', render);
          el.addEventListener('change', render);
        });
        render();
      }

      function initInventoryPagination() {
        var rows = Array.prototype.slice.call(document.querySelectorAll('#inventory-table-body .inventory-row-consolidado'));
        if (!rows.length) return;
        var listView = document.getElementById('inventory-list-view');
        var serviceView = document.getElementById('inventory-service-view');
        var prev = document.getElementById('inv-prev-consolidado');
        var next = document.getElementById('inv-next-consolidado');
        var info = document.getElementById('inv-page-info-consolidado');
        var sizeSel = document.getElementById('inv-page-size-consolidado');
        var search = document.getElementById('inventory-search');
        var statusFilter = document.getElementById('inventory-status-filter');
        var backBtn = document.getElementById('inv-back-to-list');
        var svcTitle = document.getElementById('inv-service-title');
        var svcMeta = document.getElementById('inv-service-meta');
        var svcOps = document.getElementById('inv-service-ops');
        var svcSubcats = document.getElementById('inv-service-subcats');
        var svcSearch = document.getElementById('inv-service-search');
        var svcSize = document.getElementById('inv-service-page-size');
        var svcShowNoArnSwitch = document.getElementById('inv-service-show-no-arn');
        var svcBody = document.getElementById('inv-service-resource-body');
        var svcPrev = document.getElementById('inv-service-prev');
        var svcNext = document.getElementById('inv-service-next');
        var svcInfo = document.getElementById('inv-service-page-info');
        if (!listView || !serviceView || !prev || !next || !info || !sizeSel || !search || !statusFilter || !backBtn || !svcTitle || !svcMeta || !svcOps || !svcSubcats || !svcSearch || !svcSize || !svcShowNoArnSwitch || !svcBody || !svcPrev || !svcNext || !svcInfo) return;

        var keyPage = 'ecad-inv-page-explorer';
        var keySize = 'ecad-inv-size-explorer';
        var keyQuery = 'ecad-inv-query-explorer';
        var keyStatus = 'ecad-inv-status-explorer';
        var keySvcPage = 'ecad-inv-svc-page';
        var keySvcSize = 'ecad-inv-svc-size';
        var keySvcQuery = 'ecad-inv-svc-query';
        var keySvcShowNoArn = 'ecad-inv-svc-show-no-arn';

        var page = 1;
        var size = parseInt(sizeSel.value || '25', 10) || 25;
        var filtered = rows.slice();
        var selectedService = null;
        var selectedResourcesReal = [];
        var selectedEntitiesReal = [];
        var selectedOpsReal = [];
        var servicePage = 1;
        var serviceSize = parseInt(svcSize.value || '50', 10) || 50;
        var serviceFiltered = [];
        var showNoArn = false;

        try {
          var pStored = parseInt(localStorage.getItem(keyPage) || '1', 10);
          var sStored = parseInt(localStorage.getItem(keySize) || String(size), 10);
          var qStored = localStorage.getItem(keyQuery) || '';
          var stStored = localStorage.getItem(keyStatus) || 'all';
          var spStored = parseInt(localStorage.getItem(keySvcPage) || '1', 10);
          var ssStored = parseInt(localStorage.getItem(keySvcSize) || String(serviceSize), 10);
          var sqStored = localStorage.getItem(keySvcQuery) || '';
          var snaStored = localStorage.getItem(keySvcShowNoArn) || 'false';
          if (!isNaN(pStored) && pStored > 0) page = pStored;
          if (!isNaN(sStored) && sStored > 0) size = sStored;
          if (!isNaN(spStored) && spStored > 0) servicePage = spStored;
          if (!isNaN(ssStored) && ssStored > 0) serviceSize = ssStored;
          search.value = qStored;
          statusFilter.value = stStored;
          svcSearch.value = sqStored;
          svcSize.value = String(serviceSize);
          showNoArn = snaStored === 'true';
          svcShowNoArnSwitch.checked = showNoArn;
        } catch (e) {}

        function normalizeText(v) { return (v || '').toLowerCase(); }
        function toSlug(v) { return String(v || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, ''); }
        function toArray(v) { return Array.isArray(v) ? v : []; }
        function buildResourceEntities(items, serviceName) {
          var list = toArray(items);
          function isLikelyCidr(text) {
            if (!text) return false;
            var s = String(text).trim();
            return /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/.test(s) || /^[0-9a-fA-F:]+\/\d{1,3}$/.test(s);
          }
          function isLikelyIp(text) {
            if (!text) return false;
            var s = String(text).trim();
            return /^(\d{1,3}\.){3}\d{1,3}$/.test(s) || /^[0-9a-fA-F:]{2,}$/.test(s);
          }
          function looksTechnicalValue(text) {
            if (!text) return true;
            var s = String(text).trim();
            if (!s) return true;
            if (s.indexOf('arn:') === 0) return true;
            if (isLikelyCidr(s) || isLikelyIp(s)) return true;
            if (/^ip-\d+-\d+-\d+-\d+\.ec2\.internal$/i.test(s)) return true;
            if (/^sg-[a-z0-9]+$/i.test(s) || /^subnet-[a-z0-9]+$/i.test(s) || /^vpc-[a-z0-9]+$/i.test(s)) return true;
            if (/^i-[a-z0-9]+$/i.test(s) || /^vol-[a-z0-9]+$/i.test(s) || /^snap-[a-z0-9]+$/i.test(s)) return true;
            return false;
          }
          function deriveIdFromArn(arn) {
            if (!arn) return '';
            var tailSlash = arn.split('/').pop() || '';
            if (tailSlash && tailSlash !== arn) return tailSlash;
            var tailColon = arn.split(':').pop() || '';
            if (tailColon && tailColon !== arn) return tailColon;
            return '';
          }
          function idPrefixScoreForSubcategory(id, subcategory) {
            var sid = String(id || '').toLowerCase();
            var sub = String(subcategory || '').toLowerCase();
            var map = [
              ['subnets', 'subnet-'],
              ['vpcs', 'vpc-'],
              ['instances', 'i-'],
              ['volumes', 'vol-'],
              ['snapshots', 'snap-'],
              ['security groups', 'sg-'],
              ['route tables', 'rtb-'],
              ['network interfaces', 'eni-'],
              ['internet gateways', 'igw-'],
              ['nat gateways', 'nat-'],
            ];
            for (var i = 0; i < map.length; i++) {
              if (sub === map[i][0]) return sid.indexOf(map[i][1]) === 0 ? 100 : 0;
            }
            return 0;
          }
          function scoreIdCandidate(entry, key, candidate) {
            var k = String(key || '').toLowerCase();
            var c = String(candidate || '').toLowerCase();
            var score = 0;
            if (!c) return score;
            if (/^([a-z]{1,12}-[a-z0-9]+)/i.test(c)) score += 10;
            if (/\.subnetid$/.test(k)) score += 50;
            if (/\.vpcid$/.test(k)) score += 40;
            if (/\.instanceid$/.test(k)) score += 50;
            if (/\.volumeid$/.test(k)) score += 50;
            if (/\.snapshotid$/.test(k)) score += 50;
            if (/\.networkinterfaceid$/.test(k)) score += 50;
            score += idPrefixScoreForSubcategory(c, entry.subcategory || '');
            if (entry.arn) {
              var tail = deriveIdFromArn(entry.arn).toLowerCase();
              if (tail && c === tail) score += 500;
              else if (tail) score -= 200;
            }
            return score;
          }
          function normalizeEntityKey(rawKey) {
            var ek = String(rawKey || '').trim();
            if (!ek) return '';
            var parts = ek.split('.');
            var out = [];
            var indexedCount = 0;
            for (var i = 0; i < parts.length; i++) {
              out.push(parts[i]);
              if (/\[\d+\]/.test(parts[i])) indexedCount += 1;
              // Mantener hasta la entidad principal (ej: data[0].subnets[3])
              if (indexedCount >= 2) break;
            }
            return out.join('.');
          }
          function pickDisplay(e) {
            var n = String(e.name || '').trim();
            var i = String(e.id || '').trim();
            var v = String(e.value || '').trim();
            var a = String(e.arn || '').trim();
            if (n && !looksTechnicalValue(n) && n !== a && n !== i) return n;
            if (i && i !== a) return i;
            if (v && v !== a) return v;
            if (a) return a;
            return '—';
          }
          function pickName(e) {
            var n = String(e.name || '').trim();
            var i = String(e.id || '').trim();
            var v = String(e.value || '').trim();
            var a = String(e.arn || '').trim();
            if (n && !looksTechnicalValue(n) && n !== a) return n;
            if (i && i !== a) return i;
            if (a) {
              var tail = deriveIdFromArn(a);
              if (tail) return tail;
            }
            if (v && !looksTechnicalValue(v)) return v;
            if (v) return v;
            return '—';
          }
          function entityMatchesSubcategory(e) {
            var sub = String(e.subcategory || '').toLowerCase();
            var id = String(e.id || '').toLowerCase();
            var arn = String(e.arn || '').toLowerCase();
            function ok(prefix, arnToken) {
              if (id && id.indexOf(prefix) === 0) return true;
              if (arn && arn.indexOf(arnToken) >= 0) return true;
              return false;
            }
            var strict = {
              'vpcs': ['vpc-', ':vpc/'],
              'subnets': ['subnet-', ':subnet/'],
              'instances': ['i-', ':instance/'],
              'volumes': ['vol-', ':volume/'],
              'snapshots': ['snap-', ':snapshot/'],
              'security groups': ['sg-', ':security-group/'],
              'route tables': ['rtb-', ':route-table/'],
              'network interfaces': ['eni-', ':network-interface/'],
              'internet gateways': ['igw-', ':internet-gateway/'],
              'nat gateways': ['nat-', ':natgateway/'],
            };
            if (!strict[sub]) return true;
            return ok(strict[sub][0], strict[sub][1]);
          }
          function makeEntry(canonical, subcategory) {
            return {
              canonical: canonical,
              subcategory: subcategory || 'Otros',
              arn: null,
              name: null,
              id: null,
              idScore: -1,
              value: null,
              kind: 'value'
            };
          }
          function absorb(entry, item) {
            var value = String((item && item.value) || '').trim();
            if (!value) return;
            var key = String((item && item.key) || '');
            var kind = (item && item.kind) || 'value';
            var resolvedArn = String((item && item.resolved_arn) || '').trim();
            if (value.indexOf('arn:') === 0) entry.arn = value;
            else if (!entry.arn && resolvedArn.indexOf('arn:') === 0) entry.arn = resolvedArn;
            if (kind === 'name' || /name$/i.test(key)) {
              if (!looksTechnicalValue(value) && !entry.name) entry.name = value;
              else if (!entry.value) entry.value = value;
            } else if (kind === 'id' || /id$/i.test(key)) {
              var candidateScore = scoreIdCandidate(entry, key, value);
              if (!entry.id || candidateScore >= entry.idScore) {
                entry.id = value;
                entry.idScore = candidateScore;
              }
            }
            else if (!entry.value) entry.value = value;
            if (!entry.value) entry.value = value;
            if (entry.name) entry.kind = 'name';
            else if (entry.id) entry.kind = 'id';
            else if (entry.value) entry.kind = kind || 'value';
          }

          // Paso 1: agrupar por entity_key cuando exista (misma entidad del payload).
          var byEntity = {};
          var looseItems = [];
          list.forEach(function(item) {
            var value = String((item && item.value) || '').trim();
            if (!value) return;
            var subcategory = (item && item.subcategory) || 'Otros';
            var entityKey = normalizeEntityKey((item && item.entity_key) || '');
            if (entityKey) {
              var ek = subcategory + '::' + entityKey;
              if (!byEntity[ek]) byEntity[ek] = makeEntry(ek, subcategory);
              absorb(byEntity[ek], item);
            } else {
              looseItems.push(item);
            }
          });

          // Paso 2: items sueltos (sin entity_key) se agrupan por ARN o por subcategory+valor.
          var byLoose = {};
          looseItems.forEach(function(item) {
            var value = String((item && item.value) || '').trim();
            var subcategory = (item && item.subcategory) || 'Otros';
            var lk = value.indexOf('arn:') === 0 ? value : (subcategory + '::' + value.toLowerCase());
            if (!byLoose[lk]) byLoose[lk] = makeEntry(lk, subcategory);
            absorb(byLoose[lk], item);
          });

          // Paso 3: fusionar todo y deduplicar final por ARN (si existe), sino por clave canónica.
          var merged = {};
          function pushEntry(e) {
            var mk = e.arn ? ('arn::' + e.arn) : ('key::' + e.canonical);
            if (!merged[mk]) merged[mk] = makeEntry(mk, e.subcategory);
            var t = merged[mk];
            if (e.arn) t.arn = e.arn;
            if (e.name && !t.name) t.name = e.name;
            if (e.id && !t.id) t.id = e.id;
            if (e.value && !t.value) t.value = e.value;
            if ((e.idScore || -1) > (t.idScore || -1)) {
              t.id = e.id;
              t.idScore = e.idScore;
            }
            t.kind = t.name ? 'name' : (t.id ? 'id' : (e.kind || t.kind));
          }
          Object.keys(byEntity).forEach(function(k) { pushEntry(byEntity[k]); });
          Object.keys(byLoose).forEach(function(k) { pushEntry(byLoose[k]); });

          var preliminary = Object.keys(merged).map(function(k) {
            var e = merged[k];
            if (!e.id && e.arn) {
              var arnTail = deriveIdFromArn(e.arn);
              if (arnTail) e.id = arnTail;
            }
            e.display = pickDisplay(e);
            e.name_display = pickName(e);
            e.arn_display = e.arn || 'ARN no disponible en API fuente';
            return e;
          });

          // Deduplicación final: prioriza ARN; si no hay ARN usa clave estable para no ocultar recursos.
          var finalMap = {};
          preliminary.forEach(function(e) {
            var finalKey = e.arn
              ? ('arn::' + e.arn)
              : (
                e.id
                  ? ('id::' + normalizeText((e.subcategory || '') + '::' + e.id))
                  : ('key::' + normalizeText((e.subcategory || '') + '::' + (e.value || e.name_display || e.display || '')))
              );
            if (!finalMap[finalKey]) {
              finalMap[finalKey] = e;
              return;
            }
            var cur = finalMap[finalKey];
            if (!cur.name && e.name) cur.name = e.name;
            if (!cur.id && e.id) cur.id = e.id;
            if (!cur.arn && e.arn) cur.arn = e.arn;
            if (!cur.value && e.value) cur.value = e.value;
            if ((e.idScore || -1) > (cur.idScore || -1)) {
              cur.id = e.id;
              cur.idScore = e.idScore;
            }
            cur.display = pickDisplay(cur);
            cur.name_display = pickName(cur);
            cur.arn_display = cur.arn || 'ARN no disponible en API fuente';
            if (!cur.subcategory && e.subcategory) cur.subcategory = e.subcategory;
            cur.kind = cur.name ? 'name' : (cur.id ? 'id' : (cur.kind || e.kind || 'value'));
          });

          // Segunda pasada: colapsar duplicados por subcategoría+id (prioriza filas con ARN).
          var byId = {};
          Object.keys(finalMap).forEach(function(k) {
            var e = finalMap[k];
            var idKey = e.id ? normalizeText((e.subcategory || '') + '::' + e.id) : '';
            if (!idKey) {
              byId[k] = e;
              return;
            }
            if (!byId[idKey]) {
              byId[idKey] = e;
              return;
            }
            var cur = byId[idKey];
            var winner = cur;
            if (!cur.arn && e.arn) winner = e;
            if (winner !== cur) {
              if (!winner.name && cur.name) winner.name = cur.name;
              if (!winner.value && cur.value) winner.value = cur.value;
              if (!winner.id && cur.id) winner.id = cur.id;
              if (!winner.subcategory && cur.subcategory) winner.subcategory = cur.subcategory;
              winner.name_display = pickName(winner);
              winner.arn_display = winner.arn || 'ARN no disponible en API fuente';
              byId[idKey] = winner;
            } else {
              if (!cur.arn && e.arn) cur.arn = e.arn;
              if (!cur.name && e.name) cur.name = e.name;
              if (!cur.value && e.value) cur.value = e.value;
              cur.name_display = pickName(cur);
              cur.arn_display = cur.arn || 'ARN no disponible en API fuente';
            }
          });

          // Tercera pasada: colapsar duplicados por subcategoría+nombre cuando uno tenga ARN y otro no.
          var byName = {};
          Object.keys(byId).forEach(function(k) {
            var e = byId[k];
            var nkey = normalizeText((e.subcategory || '') + '::' + (e.name_display || ''));
            if (!e.name_display || e.name_display === '—') {
              byName[k] = e;
              return;
            }
            if (!byName[nkey]) {
              byName[nkey] = e;
              return;
            }
            var cur = byName[nkey];
            var winner = cur;
            if (!cur.arn && e.arn) winner = e;
            if (winner !== cur) {
              if (!winner.id && cur.id) winner.id = cur.id;
              if (!winner.value && cur.value) winner.value = cur.value;
              winner.name_display = pickName(winner);
              winner.arn_display = winner.arn || 'ARN no disponible en API fuente';
              byName[nkey] = winner;
            } else {
              if (!cur.arn && e.arn) cur.arn = e.arn;
              if (!cur.id && e.id) cur.id = e.id;
              if (!cur.value && e.value) cur.value = e.value;
              cur.name_display = pickName(cur);
              cur.arn_display = cur.arn || 'ARN no disponible en API fuente';
            }
          });

          return Object.keys(byName).map(function(k) { return byName[k]; }).filter(entityMatchesSubcategory).sort(function(a, b) {
            var sa = normalizeText(a.subcategory);
            var sb = normalizeText(b.subcategory);
            if (sa < sb) return -1;
            if (sa > sb) return 1;
            var da = normalizeText(a.display);
            var db = normalizeText(b.display);
            if (da < db) return -1;
            if (da > db) return 1;
            return 0;
          });
        }

        function countSubcategories(entities) {
          var map = {};
          toArray(entities).forEach(function(e) {
            var name = e.subcategory || 'Otros';
            map[name] = (map[name] || 0) + 1;
          });
          return Object.keys(map).sort(function(a, b) { return map[b] - map[a]; }).map(function(name) {
            return { name: name, count: map[name] };
          });
        }

        function arnCategory(item) {
          if (item && item.arn) return 'Con ARN';
          if (item && item.kind === 'catalog') return 'Catálogo/API (sin ARN en respuesta)';
          if (item && item.id) return 'Recurso sin ARN en la operación base';
          return 'Dato auxiliar/no recurso';
        }

        function applyFilters() {
          var query = normalizeText(search.value.trim());
          var status = statusFilter.value || 'all';
          filtered = rows.filter(function(row) {
            var okStatus = status === 'all' || row.getAttribute('data-status') === status;
            if (!okStatus) return false;
            if (!query) return true;
            var hay = normalizeText([
              row.getAttribute('data-service'),
              row.getAttribute('data-resource-type'),
              row.getAttribute('data-search')
            ].join(' '));
            return hay.indexOf(query) >= 0;
          });
          page = 1;
          renderList();
        }

        function renderList() {
          var total = filtered.length;
          var totalPages = Math.max(1, Math.ceil(total / size));
          if (page > totalPages) page = totalPages;
          if (page < 1) page = 1;
          var start = (page - 1) * size;
          var end = start + size;

          rows.forEach(function(row) { row.style.display = 'none'; });
          filtered.forEach(function(row, idx) {
            row.style.display = (idx >= start && idx < end) ? '' : 'none';
          });

          prev.disabled = page <= 1;
          next.disabled = page >= totalPages;
          info.textContent = 'Página ' + page + ' de ' + totalPages + ' · ' + total + ' servicios';
          sizeSel.value = String(size);

          try {
            localStorage.setItem(keyPage, String(page));
            localStorage.setItem(keySize, String(size));
            localStorage.setItem(keyQuery, search.value || '');
            localStorage.setItem(keyStatus, statusFilter.value || 'all');
          } catch (e) {}
        }

        function openService(row) {
          if (!row) return;
          selectedService = row.getAttribute('data-service') || 'service';
          try {
            selectedResourcesReal = JSON.parse(row.getAttribute('data-samples-real-json') || '[]');
          } catch (e) {
            selectedResourcesReal = [];
          }
          try {
            selectedOpsReal = JSON.parse(row.getAttribute('data-ops-real-json') || '[]');
          } catch (e) {
            selectedOpsReal = [];
          }
          selectedEntitiesReal = buildResourceEntities(selectedResourcesReal, selectedService);
          var resourceType = row.getAttribute('data-resource-type') || 'Resources';

          svcTitle.textContent = selectedService;
          svcMeta.textContent = 'Tipo principal: ' + resourceType;
          servicePage = 1;
          renderServiceResources();

          rows.forEach(function(r) { r.classList.remove('is-selected'); });
          row.classList.add('is-selected');
          listView.classList.add('is-hidden');
          serviceView.classList.add('is-open');
          try { window.location.hash = 'inv-svc-' + toSlug(selectedService); } catch (e) {}
        }

        function closeService() {
          selectedService = null;
          listView.classList.remove('is-hidden');
          serviceView.classList.remove('is-open');
          rows.forEach(function(r) { r.classList.remove('is-selected'); });
          try {
            if (window.location.hash.indexOf('#inv-svc-') === 0) {
              history.replaceState(null, '', window.location.pathname + window.location.search);
            }
          } catch (e) {}
        }

        function renderServiceResources() {
          var allEntities = selectedEntitiesReal.slice();
          var totalEntities = allEntities.length;
          var withArnCount = allEntities.filter(function(item) { return !!item.arn; }).length;
          var activeEntities = allEntities;
          if (!showNoArn) {
            activeEntities = activeEntities.filter(function(item) { return !!item.arn; });
          }
          var activeSubcategories = countSubcategories(activeEntities);
          svcMeta.textContent = (svcMeta.textContent || '').split(' · ')[0] + ' · Con ARN: ' + withArnCount + ' / ' + totalEntities + ' · Mostrados: ' + activeEntities.length;
          svcOps.textContent = selectedOpsReal.length ? selectedOpsReal.join(', ') : '—';
          svcSubcats.innerHTML = '';
          if (activeSubcategories.length) {
            activeSubcategories.forEach(function(item) {
              var chip = document.createElement('span');
              chip.className = 'inventory-chip';
              chip.textContent = (item.name || 'Otros') + ': ' + String(item.count || 0);
              svcSubcats.appendChild(chip);
            });
          } else {
            svcSubcats.innerHTML = '<span class="inventory-chip">Sin subcategorías detectadas</span>';
          }

          var query = normalizeText(svcSearch.value.trim());
          serviceFiltered = activeEntities.filter(function(item) {
            if (!query) return true;
            var hay = normalizeText([
              item.name_display || item.display || '',
              item.arn_display || item.arn || '',
              arnCategory(item),
              item.id || '',
              item.kind || '',
              item.subcategory || '',
            ].join(' '));
            return hay.indexOf(query) >= 0;
          });

          var total = serviceFiltered.length;
          var totalPages = Math.max(1, Math.ceil(total / serviceSize));
          if (servicePage > totalPages) servicePage = totalPages;
          if (servicePage < 1) servicePage = 1;
          var start = (servicePage - 1) * serviceSize;
          var end = start + serviceSize;
          var slice = serviceFiltered.slice(start, end);

          svcBody.innerHTML = '';
          if (!slice.length) {
            svcBody.innerHTML = '<tr><td colspan="6">No hay recursos para los filtros actuales.</td></tr>';
          } else {
            slice.forEach(function(item, i) {
              var tr = document.createElement('tr');
              var idx = document.createElement('td');
              idx.textContent = String(start + i + 1);
              var value = document.createElement('td');
              value.className = 'value';
              value.textContent = item.name_display || item.display || '—';
              var arn = document.createElement('td');
              arn.className = 'value';
              arn.textContent = item.arn_display || item.arn || 'ARN no disponible en API fuente';
              var arnCat = document.createElement('td');
              arnCat.textContent = arnCategory(item);
              var subcat = document.createElement('td');
              subcat.textContent = item.subcategory || 'Otros';
              var kind = document.createElement('td');
              kind.className = 'kind';
              kind.textContent = item.kind || 'value';
              tr.appendChild(idx);
              tr.appendChild(value);
              tr.appendChild(arn);
              tr.appendChild(arnCat);
              tr.appendChild(subcat);
              tr.appendChild(kind);
              svcBody.appendChild(tr);
            });
          }
          svcPrev.disabled = servicePage <= 1;
          svcNext.disabled = servicePage >= totalPages;
          svcInfo.textContent = 'Página ' + servicePage + ' de ' + totalPages + ' · ' + total + ' recursos';

          try {
            localStorage.setItem(keySvcPage, String(servicePage));
            localStorage.setItem(keySvcSize, String(serviceSize));
            localStorage.setItem(keySvcQuery, svcSearch.value || '');
            localStorage.setItem(keySvcShowNoArn, showNoArn ? 'true' : 'false');
          } catch (e) {}
        }

        rows.forEach(function(row) {
          row.addEventListener('click', function() { openService(row); });
          var link = row.querySelector('.inventory-service-link');
          if (link) {
            link.addEventListener('click', function(ev) {
              ev.preventDefault();
              ev.stopPropagation();
              openService(row);
            });
          }
        });
        prev.addEventListener('click', function() {
          if (page > 1) { page -= 1; renderList(); }
        });
        next.addEventListener('click', function() {
          var totalPages = Math.max(1, Math.ceil(filtered.length / size));
          if (page < totalPages) { page += 1; renderList(); }
        });
        sizeSel.addEventListener('change', function() {
          var val = parseInt(sizeSel.value || '25', 10);
          size = (!isNaN(val) && val > 0) ? val : 25;
          page = 1;
          renderList();
        });
        search.addEventListener('input', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        backBtn.addEventListener('click', closeService);
        svcSearch.addEventListener('input', function() {
          servicePage = 1;
          renderServiceResources();
        });
        svcSize.addEventListener('change', function() {
          var val = parseInt(svcSize.value || '50', 10);
          serviceSize = (!isNaN(val) && val > 0) ? val : 50;
          servicePage = 1;
          renderServiceResources();
        });
        svcShowNoArnSwitch.addEventListener('change', function() {
          showNoArn = !!svcShowNoArnSwitch.checked;
          servicePage = 1;
          renderServiceResources();
        });
        svcPrev.addEventListener('click', function() {
          if (servicePage > 1) {
            servicePage -= 1;
            renderServiceResources();
          }
        });
        svcNext.addEventListener('click', function() {
          var totalPages = Math.max(1, Math.ceil(serviceFiltered.length / serviceSize));
          if (servicePage < totalPages) {
            servicePage += 1;
            renderServiceResources();
          }
        });

        applyFilters();

        try {
          var hash = window.location.hash || '';
          if (hash.indexOf('#inv-svc-') === 0) {
            var slug = hash.replace('#inv-svc-', '');
            var match = rows.find(function(r) {
              return toSlug(r.getAttribute('data-service')) === slug;
            });
            if (match) openService(match);
          }
        } catch (e) {}
      }

      function initRemediationFilters() {
        var cards = Array.prototype.slice.call(document.querySelectorAll('.remediation-card'));
        if (!cards.length) return;
        var q = document.getElementById('rem-filter-search');
        var phase = document.getElementById('rem-filter-phase');
        var domain = document.getElementById('rem-filter-domain');
        var source = document.getElementById('rem-filter-source');
        var risk = document.getElementById('rem-filter-risk');
        var owner = document.getElementById('rem-filter-owner');
        var sla = document.getElementById('rem-filter-sla');
        var clearBtn = document.getElementById('rem-filter-clear');
        var exportCsvBtn = document.getElementById('rem-export-csv');
        var exportJsonBtn = document.getElementById('rem-export-json');
        var countEl = document.getElementById('rem-visible-count');

        function pass(v, expected) {
          if (!expected || expected === 'all') return true;
          return (v || '') === expected;
        }
        function visibleItems() {
          return cards.filter(function(card) { return card.style.display !== 'none'; });
        }
        function apply() {
          var search = (q && q.value || '').trim().toLowerCase();
          cards.forEach(function(card) {
            var s = card.querySelector('summary');
            if (!s) return;
            var ok =
              pass(s.getAttribute('data-phase'), phase && phase.value) &&
              pass(s.getAttribute('data-domain'), domain && domain.value) &&
              pass(s.getAttribute('data-source'), source && source.value) &&
              pass(s.getAttribute('data-risk'), risk && risk.value) &&
              pass(s.getAttribute('data-owner'), owner && owner.value) &&
              pass(s.getAttribute('data-sla'), sla && sla.value);
            if (ok && search) {
              ok = (s.getAttribute('data-search') || '').indexOf(search) >= 0;
            }
            card.style.display = ok ? '' : 'none';
          });
          if (countEl) {
            countEl.textContent = visibleItems().length + ' de ' + cards.length + ' acciones visibles';
          }
        }
        function toExportRows() {
          return visibleItems().map(function(card) {
            var s = card.querySelector('summary');
            return {
              id: s.getAttribute('data-id') || '',
              title: s.getAttribute('data-title') || '',
              phase: s.getAttribute('data-phase') || '',
              domain: s.getAttribute('data-domain') || '',
              source: s.getAttribute('data-source') || '',
              risk: s.getAttribute('data-risk') || '',
              owner: s.getAttribute('data-owner') || '',
              sla_days: s.getAttribute('data-sla') || '',
              recommendation: s.getAttribute('data-recommendation') || ''
            };
          });
        }
        function download(name, content, type) {
          var blob = new Blob([content], { type: type });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
        function toCsv(rows) {
          var cols = ['id','title','phase','domain','source','risk','owner','sla_days','recommendation'];
          function esc(v) {
            var s = String(v == null ? '' : v);
            if (/[",\n]/.test(s)) s = '"' + s.replace(/"/g, '""') + '"';
            return s;
          }
          var out = [cols.join(',')];
          rows.forEach(function(r) {
            out.push(cols.map(function(c){ return esc(r[c]); }).join(','));
          });
          return out.join('\n');
        }

        [q, phase, domain, source, risk, owner, sla].forEach(function(el) {
          if (el) el.addEventListener('input', apply);
          if (el) el.addEventListener('change', apply);
        });
        if (clearBtn) clearBtn.addEventListener('click', function() {
          if (q) q.value = '';
          if (phase) phase.value = 'all';
          if (domain) domain.value = 'all';
          if (source) source.value = 'all';
          if (risk) risk.value = 'all';
          if (owner) owner.value = 'all';
          if (sla) sla.value = 'all';
          apply();
        });
        if (exportJsonBtn) exportJsonBtn.addEventListener('click', function() {
          var rows = toExportRows();
          download('remediation-plan-visible.json', JSON.stringify(rows, null, 2), 'application/json');
        });
        if (exportCsvBtn) exportCsvBtn.addEventListener('click', function() {
          var rows = toExportRows();
          download('remediation-plan-visible.csv', toCsv(rows), 'text/csv;charset=utf-8;');
        });
        apply();
      }
    })();
  </script>
</body>
</html>
